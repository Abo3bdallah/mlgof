<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>من الملقوف</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* NEW: Modern Teal/Cyan to Deep Blue Gradient */
            background: linear-gradient(135deg, #16a085 0%, #2980b9 100%);
            margin: 0;
            /* ADJUSTED: Padding only 10px top/bottom, 0px left/right */
            padding: 10px 0; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
        }
        .container {
            /* REMOVED: max-w-4xl mx-auto to allow full width */
            width: 100%;
            max-width: 900px; /* Kept a sensible max width for content inside */
            margin: 0 auto;
            /* Added horizontal padding here instead of body to control content width */
            padding: 0 10px; 
        }

        /* --- START Player Input Field Styles (New) --- */
        .player-input-style {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75em 1em;
            border: 2px solid #5a5a5a;
            border-radius: 10px;
            background: #2d3748; /* Darker background */
            color: #ffffff;
            font-size: 1rem;
            box-shadow: 0 0 0 1px #4b5563;
            transition: all 0.3s ease;
        }

        .player-input-style::placeholder {
            color: #9ca3af;
        }

        .player-input-style:focus {
            outline: none;
            border-color: #019b98; /* NEW: Teal focus color */
            box-shadow: 0 0 0 2px #019b98, 0 0 10px rgba(1, 155, 152, 0.5);
            transform: translateY(-2px);
        }
        /* --- END Player Input Field Styles --- */

        /* --- START Card Selection Styles --- */
       
        .go-corner {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            width: 2em;
            height: 2em;
            overflow: hidden;
            top: 0;
            right: 0;
            background: #000000; /* Black */
            border-radius: 0 10px 0 32px; 
            z-index: 2;
        }

        .go-arrow {
            margin-top: -4px;
            margin-right: -4px;
            color: white;
            font-family: courier, sans;
            font-weight: bold;
        }

        .card {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            width: 100%;
            /* FIX: Set fixed height for consistent card size */
            min-height: 140px; 
            height: 140px;
            max-height: 320px;
            border-radius: 10px;
            padding: 1.5em 1em;
            text-decoration: none;
            z-index: 0;
            overflow: hidden;
            background: #1f2937; 
            font-family: Arial, Helvetica, sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-out;
            text-align: center;
        }

        .card-img-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -3; 
            background-color: #2d3748; /* Dark fill color for empty space */
            background-position: center;
            background-repeat: no-repeat;
            opacity: 1;
            border-radius: 10px;
            transition: opacity 0.3s ease-out;
        }
       
        /* --- Desktop Images (min-width: 640px) --- */
        @media (min-width: 640px) {
            .card-img-overlay {
                /* FIX 1: Desktop images use COVER to fill, preventing gaps */
                background-size: cover; 
            }
        }
       
        /* --- Mobile Images (max-width: 639px) --- */
        @media (max-width: 639px) {
            .card-img-overlay {
                /* CHANGED: Changed from 'contain' to 'cover' to remove edges */
                background-size: cover; 
            }
        }

        /* Setting up Image URLs for all screen sizes together */
        .card[data-category="foods"] .card-img-overlay { background-image: url('https://i.postimg.cc/7Ly0r7nv/image.png'); }
        .card[data-category="animals"] .card-img-overlay { background-image: url('https://i.postimg.cc/C5ZWDdrQ/7.png'); }
        .card[data-category="countries"] .card-img-overlay { background-image: url('https://i.postimg.cc/D0WtsmpH/8.png'); }
        .card[data-category="produce"] .card-img-overlay { background-image: url('https://i.postimg.cc/zXn1ktkH/9.png'); }
        .card[data-category="drinks"] .card-img-overlay { background-image: url('https://i.postimg.cc/Y04JgjDP/6.png'); }
        .card[data-category="clothing"] .card-img-overlay { background-image: url('https://i.postimg.cc/65dNhjhC/10.png'); }
        .card[data-category="places"] .card-img-overlay { background-image: url('https://i.postimg.cc/8cFqWsn1/11.png'); }
        .card[data-category="professions"] .card-img-overlay { background-image: url('https://iili.io/KhAdhGa.png'); }
        .card[data-category="sports_games"] .card-img-overlay { background-image: url('https://iili.io/KhAdOaR.png'); }
        .card[data-category="brands"] .card-img-overlay { background-image: url('https://iili.io/KhAdj6J.png'); }
        .card[data-category="quran_characters"] .card-img-overlay { background-image: url('https://iili.io/KhAdkyN.png'); }
        .card[data-category="sahaba"] .card-img-overlay { background-image: url('https://iili.io/KhAdevp.png'); }
        .card[data-category="quran_surahs"] .card-img-overlay { background-image: url('https://iili.io/KhAdN3v.png'); }
        .card[data-category="twoCategories"] .card-img-overlay { background-image: url('https://i.postimg.cc/vT1p9DS8/12.png'); }
        .card[data-category="random"] .card-img-overlay { background-image: url('https://i.postimg.cc/J0y9JtYT/13.png'); }


        /* Mobile specific overrides if necessary - now using the same as desktop */
        @media (max-width: 639px) {
            .card[data-category="foods"] .card-img-overlay { background-image: url('https://i.postimg.cc/cJNBWR9m/5.png'); }
            .card[data-category="animals"] .card-img-overlay { background-image: url('https://i.postimg.cc/Qd7Jv4b0/7.png'); }
            .card[data-category="countries"] .card-img-overlay { background-image: url('https://i.postimg.cc/Qd7Jv4bm/8.png'); }
            .card[data-category="produce"] .card-img-overlay { background-image: url('https://i.postimg.cc/sgW4b6cK/9.png'); }
            .card[data-category="drinks"] .card-img-overlay { background-image: url('https://i.postimg.cc/Pr9M3s1c/6.png'); }
            .card[data-category="clothing"] .card-img-overlay { background-image: url('https://i.postimg.cc/rw4N7nJJ/10.png'); }
            .card[data-category="places"] .card-img-overlay { background-image: url('https://i.postimg.cc/W4PwVGWw/11.png'); }
            .card[data-category="professions"] .card-img-overlay { background-image: url('https://i.postimg.cc/2SQw5Bcb/14.png'); }
            .card[data-category="sports_games"] .card-img-overlay { background-image: url('https://i.postimg.cc/9Qdpfq8r/12.png'); }
            .card[data-category="brands"] .card-img-overlay { background-image: url('https://i.postimg.cc/XYf8vyHB/15.png'); }
            .card[data-category="quran_characters"] .card-img-overlay { background-image: url('https://i.postimg.cc/QdQbMW43/17.png'); }
            .card[data-category="sahaba"] .card-img-overlay { background-image: url('https://i.postimg.cc/BvJCPQkt/16.png'); }
            .card[data-category="quran_surahs"] .card-img-overlay { background-image: url('https://i.postimg.cc/2SQw5Bcq/13.png'); }
            .card[data-category="twoCategories"] .card-img-overlay { background-image: url('https://i.postimg.cc/YSwz76nx/12.png'); }
            .card[data-category="random"] .card-img-overlay { background-image: url('https://i.postimg.cc/yNzyKmQX/13.png'); }
        }


        /* Hover effect: dark overlay appears */
        .card:before {
            content: '';
            position: absolute;
            z-index: 1; 
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4); 
            opacity: 0;
            transition: opacity 0.3s ease-out;
            border-radius: 10px;
        }

        /* Reveal tooltip/description on hover */
        .card:hover:before {
            opacity: 1;
        }
       
        .card-description-box {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            padding: 1rem;
            text-shadow: 0 0 5px #000;
        }

        .card:hover .card-description-box {
            opacity: 1;
        }
       
        /* --- END Card Selection Styles --- */

        /* --- START Question Turn Display (REDESIGNED) --- */
        .question-turn-container {
            display: flex;
            justify-content: center;
            align-items: stretch; /* Make cards same height */
            gap: 1rem;
            flex-wrap: wrap; 
        }

        .player-turn-card {
            box-sizing: border-box;
            flex: 1; 
            min-width: 220px;
            max-width: 300px;
            background: linear-gradient(160deg, #2a3a50 0%, #1e293b 100%); 
            border-radius: 16px;
            border-bottom: 4px solid; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex; 
            align-items: center;
            padding: 1.25rem;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .player-turn-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
        }

        .player-turn-card.asker { border-color: #38bdf8; } /* Light Blue */
        .player-turn-card.answerer { border-color: #34d399; } /* Emerald Green */

        .card-icon-area {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-icon-area svg {
            width: 28px;
            height: 28px;
            stroke-width: 2;
        }
        .player-turn-card.asker .card-icon-area { background-color: rgba(56, 189, 248, 0.1); }
        .player-turn-card.asker svg { color: #38bdf8; }
        .player-turn-card.answerer .card-icon-area { background-color: rgba(52, 211, 153, 0.1); }
        .player-turn-card.answerer svg { color: #34d399; }

        .card-text-area {
            text-align: right;
            color: white;
            overflow: hidden;
            flex-grow: 1;
        }

        .player-label {
            font-size: 0.875rem; 
            color: #9ca3af; 
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .player-name {
            font-size: 1.5rem; 
            font-weight: 700; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        .asks-divider {
            font-size: 1.5rem; 
            font-weight: bold;
            color: #fff;
            align-self: center;
            flex-shrink: 0; 
        }

        @media (max-width: 640px) {
            .question-turn-container {
                gap: 0.75rem;
            }
            .player-turn-card {
                width: 100%; 
                max-width: none;
                min-width: unset;
                padding: 1rem;
            }
            .player-name {
                font-size: 1.25rem;
            }
            .asks-divider {
                width: 100%;
                text-align: center;
                padding: 0.5rem 0;
            }
        }
        /* --- END Question Turn Display (REDESIGNED) --- */

        /* Custom styles for the Modal and other elements remain the same */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .two-cat-modal-content {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        #modalCategoriesGrid {
            overflow-y: auto;
            flex-grow: 1; /* Allows grid to take up available space */
        }


        /* Number Input Styles */
        .number-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 0.75rem;
        }
        .number-input-display {
            background-color: #1f2937;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            width: 60px;
            text-align: center;
            font-weight: bold;
        }
        .imposter-count-text { color: #d1d5db; }
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1f2937; 
            border: 2px solid #ef4444; 
            border-radius: 1.5rem; 
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            max-width: 90%;
            width: 350px;
            text-align: center;
        }
        .custom-alert-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
        }
       
        /* --- START Start Game Animated Button Styles (.btn) --- */
        .btn {
            /* NEW: Orange/Teal/Cyan Border Color */
            --border-color: linear-gradient(-45deg, #f6ad55, #16a085, #4ade80);
            --border-width: 0.125em;
            --curve-size: 0.5em;
            --bg: #1f2937; 
            --color: #ffffff;
            color: var(--color);
            cursor: pointer;
            position: relative;
            isolation: isolate;
            display: inline-grid;
            place-content: center;
            padding: 1em 2em; 
            width: 100%;
            font-size: 1.125rem; 
            font-weight: 700;
            border: 0;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); 
            clip-path: polygon(
                0% var(--curve-size),
                var(--curve-size) 0,
                100% 0,
                100% calc(100% - var(--curve-size)),
                calc(100% - var(--curve-size)) 100%,
                0 100%
            );
            transition: color 250ms, box-shadow 250ms;
        }

        .btn::after, .btn::before { content: ""; position: absolute; inset: 0; }
        .btn::before {
            background: var(--border-color);
            background-size: 300% 300%;
            animation: move-bg7234 5s ease infinite;
            z-index: -2;
        }

        @keyframes move-bg7234 {
            0% { background-position: 31% 0%; }
            50% { background-position: 70% 100%; }
            100% { background-position: 31% 0%; }
        }

        .btn::after {
            background: var(--bg);
            z-index: -1;
            clip-path: polygon(
                var(--border-width) calc(var(--curve-size) + var(--border-width) * 0.5),
                calc(var(--curve-size) + var(--border-width) * 0.5) var(--border-width),
                calc(100% - var(--border-width)) var(--border-width),
                calc(100% - var(--border-width)) calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)),
                calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)) calc(100% - var(--border-width)),
                var(--border-width) calc(100% - var(--border-width))
            );
            transition: clip-path 500ms;
        }

        .btn:where(:hover, :focus)::after {
            clip-path: polygon(
                calc(100% - var(--border-width)) calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)),
                calc(100% - var(--border-width)) var(--border-width),
                calc(100% - var(--border-width)) var(--border-width),
                calc(100% - var(--border-width)) calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)),
                calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)) calc(100% - var(--border-width)),
                calc(100% - calc(var(--curve-size) + var(--border-width) * 0.5)) calc(100% - var(--border-width))
            );
            transition: 200ms;
        }

        .btn:where(:hover, :focus) {
            color: #fff;
            box-shadow: 0 0 25px rgba(246, 173, 85, 0.8); /* Focus on orange glow */
        }
        /* --- END Start Game Animated Button Styles (.btn) --- */

        /* --- START Bubble Buttons --- */
        .bubble-container {
            --bubbleTiming: cubic-bezier(0.5,0.15,0.25,1.75);
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .bubble {
            display: flex; /* Centering content */
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 -0.06em 0.1em var(--highlight, hsl(0,0%,100%)) inset,
                        0 -0.15em 0.4em var(--shadow1, hsl(0,90%,45%)) inset,
                        0 0.05em 0.05em var(--shadow2, hsl(0,90%,45%)) inset,
                        0.05em 0 0.1em var(--highlight, hsl(0,0%,100%)) inset,
                        -0.05em 0 0.1em var(--highlight, hsl(0,0%,100%)) inset,
                        0 0.1em 0.4em var(--shadow3, hsl(0,90%,60%)) inset;
            cursor: pointer;
            position: relative;
            width: 3em;
            height: 3em;
            transform-style: preserve-3d;
            transition-property: box-shadow, transform, width, height;
            transition-duration: 0.2s;
            transition-timing-function: ease-in-out, ease-in-out, var(--bubbleTiming), var(--bubbleTiming);
            will-change: transform;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            z-index: 0;
            border-radius: 50%;
        }
        .bubble:focus, .bubble:hover {
            transform: scale(1.1);
            outline: none;
        }
        /* White Dice */
        .white-bubble {
            --highlight: hsl(0,0%,100%);
            --shadow1: hsl(0,0%,70%);
            --shadow2: hsl(0,0%,70%);
            --shadow3: hsl(0,0%,80%);
            background-color: #f0f0f0;
        }
        .white-bubble.active {
            --highlight: hsl(180,90%,100%);
            --shadow1: hsl(180,90%,45%);
            --shadow2: hsl(180,90%,45%);
            --shadow3: hsl(180,90%,60%);
        }
        /* Red Dice */
        .red-bubble {
            --highlight: hsl(0,90%,100%);
            --shadow1: hsl(0,90%,45%);
            --shadow2: hsl(0,90%,45%);
            --shadow3: hsl(0,90%,60%);
        }
        .red-bubble.active {
            --highlight: hsl(10,90%,100%);
            --shadow1: hsl(10,90%,45%);
            --shadow2: hsl(10,90%,45%);
            --shadow3: hsl(10,90%,60%);
        }
        /* --- END Bubble Buttons --- */

        /* --- START 3D Buttons for +/- --- */
        .button-3d {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            border-width: 0;
            padding: 0;
            min-width: 3em;  /* MODIFIED: Smaller size */
            min-height: 3em; /* MODIFIED: Smaller size */
            box-sizing: border-box;
            background: transparent;
            font: inherit;
            cursor: pointer;
            border-radius: 12px;
        }
        .button-top {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            transform: translateY(0);
            color: #fff;
            font-size: 1.5rem; /* MODIFIED: Bigger icon */
            text-shadow: 0 -1px rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .button-3d:active .button-top {
            transform: translateY(2px);
        }
        .button-bottom {
            position: absolute;
            z-index: 1;
            bottom: 4px;
            left: 4px;
            border-radius: 12px;
            width: calc(100% - 8px);
            height: calc(100% - 10px);
            background: #ccc;
            box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, 0.5);
        }
        .button-base {
            position: absolute;
            z-index: 0;
            top: 4px;
            left: 0;
            border-radius: 12px;
            width: 100%;
            height: calc(100% - 4px);
            background-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 1px 1px 0 rgba(255, 255, 255, 0.75),
                inset 0 2px 2px rgba(0, 0, 0, 0.25);
        }
        .button-3d-plus .button-top { background-image: linear-gradient(145deg, #2575fc, #6a11cb); }
        .button-3d-plus .button-bottom { background-image: linear-gradient(145deg, #6a11cb, #2575fc); }
        .button-3d-minus .button-top { background-image: linear-gradient(145deg, #ff416c, #ff4b2b); }
        .button-3d-minus .button-bottom { background-image: linear-gradient(145deg, #ff4b2b, #ff416c); }
        .button-3d.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-3d.disabled:active .button-top {
            transform: translateY(0); /* Prevent press effect when disabled */
        }
        /* --- END 3D Buttons --- */

       
        /* NEW: Unified Selected Category Display Styles */
        .selected-category-display-box {
            position: relative;
            background-color: #1f2937; /* Default dark background */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
       
        .selected-category-image-bg {
            /* This is the background image that covers the entire box */
            width: 100%;
            min-height: 200px; /* Ensure sufficient height */
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            position: relative;
        }

        .selected-category-content-overlay {
            /* Dark overlay for text clarity */
            background: rgba(0, 0, 0, 0.5);
            padding: 16px; 
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
        }

        .selected-category-title {
            color: white;
            font-weight: bold;
            font-size: 1.25rem; /* text-xl */
            margin-bottom: 4px;
        }

        .selected-category-subtitle {
            color: #d1d5db; /* text-gray-300 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 8px;
        }

        /* --- START Animated Button (Change Category / Start Question) --- */
        .animated-button {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 24px; /* Reduced padding for compact look */
            border: 3px solid; /* Reduced border for compact look */
            border-color: transparent;
            font-size: 1rem;
            background-color: inherit;
            border-radius: 50px;
            font-weight: 600;
            color: #019b98; /* Teal color for consistency */
            box-shadow: 0 0 0 2px #019b98;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            width: 100%; /* Ensure full width when needed */
        }
       
        .animated-button .animated-icon {
            position: absolute;
            width: 20px; /* Slightly smaller icon */
            fill: #019b98;
            z-index: 9;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
       
        .animated-button .arr-1 { right: 12px; }
        .animated-button .arr-2 { left: -20%; }
       
        .animated-button .circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-color: #019b98;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
       
        .animated-button .text {
            position: relative;
            z-index: 1;
            transform: translateX(-8px); /* Reduced translation */
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .animated-button:hover {
            /* FIXED: Ensure full background coverage on hover by increasing circle shadow transparency */
            box-shadow: 0 0 0 250px transparent; /* Increased to cover button area */
            color: #1f2937; /* Dark text on hover */
            border-radius: 8px;
        }

        .animated-button:hover .arr-1 { right: -20%; }
        .animated-button:hover .arr-2 { left: 12px; }
        .animated-button:hover .text { transform: translateX(8px); }
        .animated-button:hover .animated-icon { fill: #1f2937; }

        .animated-button:active {
            scale: 0.95;
            box-shadow: 0 0 0 3px #019b98;
        }

        .animated-button:hover .circle {
            width: 250px; /* Increased size to cover potential width */
            height: 250px;
            opacity: 1;
        }
        /* --- END Animated Button (Change Category / Start Question) --- */

        /* --- START Skip Vote Button (Icon Slide) --- */
        .skip-button {
            width: 100%;
            height: auto;
            min-height: 40px; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center; /* Align content to center initially */
            background: #cc4444; /* Dark Red */
            border: none;
            border-radius: 8px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            transition: 200ms;
            overflow: hidden;
            position: relative;
            padding: 0;
        }
       
        .skip-button .skip-text {
            /* FIXED: Ensure text is centered initially */
            transform: translateX(0); 
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 10;
            transition: 200ms;
            padding: 10px 0; /* Vertical padding */
            flex-grow: 1; /* Allow text to grow and center */
            text-align: center;
        }

        .skip-button .skip-icon-box {
            position: absolute;
            /* FIXED: Adjusted border and position for visual separation and RTL */
            border-right: 1px solid #993333; 
            transform: translateX(0);
            height: 100%;
            width: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent; /* Keep background transparent initially */
            transition: 200ms;
            right: 0;
        }

        .skip-button svg {
            width: 18px;
            fill: #eee;
        }

        .skip-button:hover {
            background: #ff5555;
        }

        .skip-button:hover .skip-text {
            color: white; /* Keep text visible in the center area */
            transform: translateX(-50px); /* Shift text slightly left (relative) to make space */
        }

        .skip-button:hover .skip-icon-box {
            /* FIXED: Expand from the right (RTL) */
            width: 100%; 
            border-right: none;
            transform: translateX(0);
            background: #ff5555;
        }

        .skip-button:active .skip-icon-box svg {
            transform: scale(0.8);
        }
        /* --- END Skip Vote Button (Icon Slide) --- */

        /* --- START Voting Card (Challenge Mode) Styles --- */
        .challenge-card {
            background-color: #4a5568;
            border: 2px solid #718096;
            transition: all 0.2s ease-in-out;
        }
        .challenge-card.selected {
            background-color: #2b6cb0;
            border-color: #4299e1;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(66, 153, 225, 0.5);
        }
        /* --- END Voting Card Styles --- */

        /* --- Custom Header Image Style --- */
        .custom-header-container {
            height: 100px; 
            width: 100%;
            padding: 0; 
            box-shadow: none; 
            overflow: hidden;
            background-color: transparent; 
            border: none; 
            margin-bottom: 24px; /* Added margin for separation */
        }
       
        .custom-header-image {
            width: 100%;
            height: 100%;
            background-image: url('https://i.postimg.cc/nVyz3pdx/image.png');
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center;
        }

        /* --- REVEAL EFFECT --- */
        @keyframes reveal-pulse {
            0%, 100% {
                transform: scale(1.5);
                text-shadow: 0 0 20px #ff4b2b;
            }
            50% {
                transform: scale(1.6);
                text-shadow: 0 0 30px #ff416c, 0 0 40px #ff4b2b;
            }
        }
        .reveal-effect {
            animation: reveal-pulse 1s ease-in-out infinite;
            color: #ff416c; /* Bright red */
        }

        /* --- SPIDER-VERSE BUTTON --- */
        .button-wrapper {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.2s ease;
            padding: 20px 0; /* Adjusted padding */
        }
        .spiderverse-button {
            position: relative;
            width: 100%; /* Full width */
            padding: 15px 30px;
            font-size: 20px; /* Adjusted font size */
            font-weight: 900;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            background: #1f2937; /* Dark background to match theme */
            color: #fff; /* White text for contrast */
            text-transform: uppercase;
            letter-spacing: 2px; /* Adjusted letter spacing */
            transform-style: preserve-3d;
            transition: all 0.15s ease;
            font-family: Arial, sans-serif;
            border: 2px solid #16a085; /* Teal border */
            text-shadow: /* Removed heavy black shadow */
                0 0 5px #16a085,
                0 0 10px #16a085;
        }

        .glitch-layers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .glitch-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1f2937; /* Match the main button background */
            border-radius: 50px;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .layer-1 {
            color: #0ff;
            transform-origin: center;
        }

        .layer-2 {
            color: #f0f;
            transform-origin: center;
        }

        .button-wrapper:hover .layer-1 {
            opacity: 1;
            animation: glitchLayer1 0.4s steps(2) infinite;
        }

        .button-wrapper:hover .layer-2 {
            opacity: 1;
            animation: glitchLayer2 0.4s steps(2) infinite;
        }

        .button-wrapper:hover .spiderverse-button {
            animation: buttonGlitch 0.3s steps(2) infinite;
            box-shadow:
                0 0 20px rgba(255, 255, 255, 0.5),
                0 0 30px rgba(0, 255, 255, 0.5),
                0 0 40px rgba(255, 0, 255, 0.5);
        }

        @keyframes buttonGlitch {
            0% { transform: translate(0); }
            25% { transform: translate(-5px, 3px) skew(-3deg); }
            50% { transform: translate(5px, -3px) skew(3deg); }
            75% { transform: translate(-8px, -2px) skew(-2deg); }
            100% { transform: translate(0); }
        }

        @keyframes glitchLayer1 {
            0% { transform: translate(-10px, -5px) skew(-5deg); clip-path: polygon(0 20%, 100% 20%, 100% 50%, 0 50%); }
            25% { transform: translate(10px, 5px) skew(5deg); clip-path: polygon(0 30%, 100% 30%, 100% 60%, 0 60%); }
            50% { transform: translate(-8px, 3px) skew(-3deg); clip-path: polygon(0 10%, 100% 10%, 100% 40%, 0 40%); }
            75% { transform: translate(8px, -3px) skew(3deg); clip-path: polygon(0 40%, 100% 40%, 100% 70%, 0 70%); }
            100% { transform: translate(-10px, -5px) skew(-5deg); clip-path: polygon(0 20%, 100% 20%, 100% 50%, 0 50%); }
        }

        @keyframes glitchLayer2 {
            0% { transform: translate(10px, 5px) skew(5deg); clip-path: polygon(0 50%, 100% 50%, 100% 80%, 0 80%); }
            25% { transform: translate(-10px, -5px) skew(-5deg); clip-path: polygon(0 60%, 100% 60%, 100% 90%, 0 90%); }
            50% { transform: translate(8px, -3px) skew(3deg); clip-path: polygon(0 40%, 100% 40%, 100% 70%, 0 70%); }
            75% { transform: translate(-8px, 3px) skew(-3deg); clip-path: polygon(0 70%, 100% 70%, 100% 100%, 0 100%); }
            100% { transform: translate(10px, 5px) skew(5deg); clip-path: polygon(0 50%, 100% 50%, 100% 80%, 0 80%); }
        }

        /* --- START Spinning Wheel Display Styles (NEW) --- */
        .spinning-wheel-container {
            background: linear-gradient(145deg, #4b5563, #1f2937); /* Dark gradient */
            border-radius: 24px; /* rounded-3xl */
            padding: 12px; /* p-3 */
            box-shadow: 0 10px 20px rgba(0,0,0,0.4), inset 0 0 15px rgba(0,0,0,0.5);
            border: 2px solid #6b7280;
        }
        .spinning-wheel-inner {
            background: #111827; /* bg-gray-900 */
            border-radius: 16px; /* rounded-2xl */
            padding: 1rem 0.5rem; /* p-4 sm:p-8 equivalent with more vertical space */
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.7);
            border: 1px solid #374151;
            min-height: 150px; /* Taller */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #currentName {
            font-size: 2.5rem; /* ~text-4xl */
            font-weight: bold;
            color: white;
            transition: all 0.15s ease-in-out;
            text-align: center;
            word-break: break-word; /* FIX: Prevents overflow */
            padding: 0 1rem; /* Horizontal padding for long names */
            line-height: 1.2;
        }
        @media (min-width: 640px) {
            #currentName {
                font-size: 4rem; /* ~text-6xl */
            }
            .spinning-wheel-inner {
                min-height: 180px;
            }
        }
        /* --- END Spinning Wheel Display Styles --- */
       
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="font-arabic">
    
    <!-- New Settings/Info Buttons -->
    <div class="fixed top-5 right-5 z-[1001] flex flex-col gap-2">
        <div id="howToPlayBtn" class="cursor-pointer bg-blue-600 p-3 rounded-full shadow-lg hover:bg-blue-700 transition-all transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </div>
        <div id="settingsBtn" class="cursor-pointer bg-cyan-600 p-3 rounded-full shadow-lg hover:bg-cyan-700 transition-all transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.55a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.39a2 2 0 0 0-.73-2.73l-.15-.07a2 2 0 0 1-1-1.73v-.55a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </div>
        <div id="scoresBtn" class="cursor-pointer bg-yellow-500 p-3 rounded-full shadow-lg hover:bg-yellow-600 transition-all transform hover:scale-110">
            <img src="https://i.postimg.cc/ZnJP94qx/image.png" alt="النتائج" class="w-6 h-6">
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-sm mx-4 border border-slate-600 relative">
            <button onclick="closeSettingsModal()" class="absolute top-3 left-3 text-gray-400 hover:text-white transition-colors text-3xl font-bold leading-none">&times;</button>
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-6 text-center">الإعدادات</h3>
            <div class="space-y-4">
                <button onclick="handleNewRoundClick()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M22 11.5A10 10 0 0 0 12.5 2a10 10 0 0 0-9.8 11.5L2 16"/><path d="M2 8.5A10 10 0 0 0 11.5 22a10 10 0 0 0 9.8-11.5L22 8"/></svg>
                    <span>إعادة الجولة</span>
                </button>
                <button onclick="showConfirmResetModal()" class="w-full bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-bold py-3 px-4 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M10 3H6a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    <span>لعبة جديدة (تصفير النقاط)</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- How To Play Modal (NEW) -->
    <div id="howToPlayModal" class="modal hidden">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-2xl mx-4 border border-slate-600 relative max-h-[90vh] flex flex-col">
            <button onclick="closeHowToPlayModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors text-3xl font-bold leading-none z-10">&times;</button>
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-6 text-center">طريقة اللعب</h3>
            <div class="space-y-4 text-slate-300 overflow-y-auto pr-2">
                <div class="p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <h4 class="font-bold text-lg text-cyan-400 mb-2">🎯 الهدف من اللعبة</h4>
                    <p>الهدف هو أن يكتشف اللاعبون العاديون من هو "الملقوف" بينهم، بينما يحاول "الملقوف" أن يخدع الجميع ويتظاهر بأنه يعرف الكلمة السرية.</p>
                </div>
                <div class="p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <h4 class="font-bold text-lg text-cyan-400 mb-2">🎭 الأدوار</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong class="text-white">اللاعب العادي:</strong> يعرف الكلمة السرية. مهمته كشف الملقوف من خلال الأسئلة.</li>
                        <li><strong class="text-red-400">الملقوف:</strong> لا يعرف الكلمة. مهمته هي التمويه والتظاهر بمعرفة الكلمة، ومحاولة تخمينها في النهاية.</li>
                    </ul>
                </div>
                <div class="p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <h4 class="font-bold text-lg text-cyan-400 mb-2 flex items-center gap-2"><img src="https://i.postimg.cc/7hZ6QMnT/image.png" class="w-6 h-6"> تحديد عدد الملاقيف</h4>
                    <p class="mb-2">يمكنك تحديد عدد الملاقيف يدوياً، أو استخدام أحد الخيارات العشوائية:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong class="text-white flex items-center gap-1">النرد الأبيض (<img src="https://i.postimg.cc/7hZ6QMnT/image.png" class="w-5 h-5 inline-block" alt="نرد أبيض">):</strong> يختار عددًا مناسبًا من الملاقيف تلقائيًا بناءً على عدد اللاعبين. (مثال: 3-5 لاعبين = 1-2 ملقوف). هذا الخيار يوازن اللعبة.</li>
                        <li><strong class="text-red-400 flex items-center gap-1">النرد الأحمر (<img src="https://i.postimg.cc/FzHRngVS/image.png" class="w-5 h-5 inline-block" alt="نرد أحمر">):</strong> يزيد من الحماس! يختار عددًا عشوائيًا من الملاقيف قد يصل إلى (عدد اللاعبين - 1). استعد للفوضى!</li>
                    </ul>
                </div>
                 <div class="p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <h4 class="font-bold text-lg text-cyan-400 mb-2">🔄 سير اللعبة</h4>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><strong>توزيع الأدوار:</strong> كل لاعب يضغط على اسمه ليرى دوره وكلمته السرية (إذا لم يكن ملقوفاً).</li>
                        <li><strong>جولة الأسئلة:</strong> يقوم كل لاعب بطرح سؤال على لاعب آخر حول الكلمة السرية.</li>
                        <li><strong>التصويت:</strong> بعد انتهاء الأسئلة، يصوت كل لاعب على من يعتقد أنه الملقوف.</li>
                        <li><strong>كشف الملقوف:</strong> يتم الكشف عن هوية الملاقيف.</li>
                        <li><strong>وش الهرجة؟:</strong> إذا لم يتم كشف كل الملاقيف، يحصلون على فرصة أخيرة لتخمين الكلمة السرية من بين عدة خيارات لكسب نقاط إضافية.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>


    <!-- Confirm Reset Modal -->
    <div id="confirmResetModal" class="modal hidden">
         <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl shadow-lg w-full max-w-xs text-center border border-slate-600">
            <p class="text-white text-lg mb-6">هل أنت متأكد؟ سيتم تصفير النقاط وبدء لعبة جديدة بنفس اللاعبين.</p>
            <div class="flex justify-center gap-4">
                <button onclick="handleResetConfirm()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">نعم، ابدأ من جديد</button>
                <button onclick="closeConfirmResetModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm New Round Modal -->
    <div id="confirmNewRoundModal" class="modal hidden">
         <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl shadow-lg w-full max-w-xs text-center border border-slate-600">
            <p class="text-white text-lg mb-6">هل أنت متأكد من بدء جولة جديدة؟</p>
            <div class="flex justify-center gap-4">
                <button onclick="handleNewRoundConfirm()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">نعم، أعد الجولة</button>
                <button onclick="closeConfirmNewRoundModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Scores Modal -->
    <div id="scoresModal" class="modal hidden">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-sm mx-4 border border-slate-600 relative">
            <button onclick="closeScoresModal()" class="absolute top-3 left-3 text-gray-400 hover:text-white transition-colors text-3xl font-bold leading-none">&times;</button>
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-6 text-center">النتائج الحالية</h3>
            <div id="scoresList" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                <!-- Scores will be populated here -->
            </div>
            <button onclick="showConfirmScoreResetModal()" class="w-full bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-bold py-3 px-4 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                <span>تصفير النقاط</span>
            </button>
        </div>
    </div>

    <!-- Confirm Score Reset Modal -->
    <div id="confirmScoreResetModal" class="modal hidden">
         <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl shadow-lg w-full max-w-xs text-center border border-slate-600">
            <p class="text-white text-lg mb-6">هل أنت متأكد من تصفير جميع النقاط؟</p>
            <div class="flex justify-center gap-4">
                <button onclick="handleScoreResetConfirm()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">نعم، صفر النقاط</button>
                <button onclick="closeConfirmScoreResetModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
            </div>
        </div>
    </div>


    <div class="container">
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8">
            <!-- FULL LOGO BANNER - Replaced gradient box with image container -->
            <div class="custom-header-container">
                <div class="custom-header-image"></div>
            </div>
        </div>

        <!-- Category Selection Phase -->
        <div id="categoryPhase" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                <img src="https://i.postimg.cc/hGr97hXT/image.png" class="w-8 h-8">
                <span>اختر التصنيف</span>
            </h2>
            <p class="text-slate-300 text-center mb-6 text-sm sm:text-base">اختر تصنيفاً للعبة أو اضغط على "تصنيفين" للدمج.</p>
           
            <div id="categoryGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-6">
                <!-- Categories will be dynamically inserted here -->
            </div>
        </div>

        <!-- Setup Phase -->
        <div id="setupPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                <img src="https://i.postimg.cc/XqYJDckK/image.png" class="w-8 h-8">
                <span>إعداد اللعبة</span>
            </h2>
           
            <!-- Selected Category Display -->
            <div id="selectedCategory" class="selected-category-display-box border border-sky-400 mb-6">
                <!-- Content will be generated by updateSelectedCategoryDisplay() -->
            </div>

            <!-- Imposters Count Input (New Buttons) -->
            <div class="mb-4 sm:mb-6 flex flex-col items-center">
                <label class="block text-base sm:text-lg font-semibold text-white mb-3 flex items-center gap-2">
                    <img src="https://i.postimg.cc/nL9N2tgc/image.png" class="w-6 h-6">
                    <span>عدد الملاقيف:</span>
                </label>
                <div class="number-input-container">
                    <button class="button-3d button-3d-minus" onclick="setImposterMode('manual', -1)">
                        <div class="button-base"></div>
                        <div class="button-bottom"></div>
                        <div class="button-top">-</div>
                    </button>
                    <div id="impostersCountDisplay" class="number-input-display">1</div>
                    <button class="button-3d button-3d-plus" onclick="setImposterMode('manual', 1)">
                        <div class="button-base"></div>
                        <div class="button-bottom"></div>
                        <div class="button-top">+</div>
                    </button>
                    <div class="bubble-container">
                        <button id="randomImposterBtn" class="bubble white-bubble" onclick="setImposterMode('random')">
                            <img src="https://i.postimg.cc/7hZ6QMnT/image.png" class="w-6 h-6">
                        </button>
                    </div>
                    <div class="bubble-container">
                        <button id="redDiceBtn" class="bubble red-bubble" onclick="setImposterMode('red_dice')">
                           <img src="https://i.postimg.cc/FzHRngVS/image.png" class="w-6 h-6">
                        </button>
                    </div>
                </div>
                <p id="imposterCountHint" class="imposter-count-text text-xs sm:text-sm mt-2">الحد الأقصى: 1</p>
            </div>

            <!-- Players Input -->
            <div class="mb-4 sm:mb-6">
                <label class="block text-base sm:text-lg font-semibold text-white mb-3 flex items-center gap-2">
                    <span class="text-xl">👥</span>
                    <span>أسماء اللاعبين (3 - 20 لاعب):</span>
                </label>
                <div id="playersContainer" class="space-y-3 mb-4">
                    <input type="text" oninput="updateMaxImposters()" class="player-input w-full p-3 player-input-style" placeholder="🎮 اللاعب 1">
                    <input type="text" oninput="updateMaxImposters()" class="player-input w-full p-3 player-input-style" placeholder="🎮 اللاعب 2">
                    <input type="text" oninput="updateMaxImposters()" class="player-input w-full p-3 player-input-style" placeholder="🎮 اللاعب 3">
                    <input type="text" oninput="updateMaxImposters()" class="player-input w-full p-3 player-input-style" placeholder="🎮 اللاعب 4">
                    <input type="text" oninput="updateMaxImposters()" class="player-input w-full p-3 player-input-style" placeholder="🎮 اللاعب 5">
                </div>
                <!-- Animated Add Player Button (KO II Style) -->
                <button onclick="addPlayer()" class="ko-btn" style="width: 100%; height: auto; padding: 1em 0.5em; background-color: #545251; box-shadow: rgba(0, 0, 0, 0.377) 10px 10px 8px, #a8a6a4 1.5px 1.5px 1px 0px inset, #545251 -3.2px -3.2px 8px 0px inset;">
                    <span style="font-size: 1rem; color: white;">+ إضافة لاعب</span>
                </button>
            </div>

            <!-- New Animated Start Game Button (.btn) -->
            <button onclick="startGame()" class="btn mt-6 w-full">
                <span>بدء اللعبة 🎮</span>
            </button>

        </div>

        <!-- Two Categories Modal -->
        <div id="twoCategoriesModal" class="modal hidden">
            <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-lg mx-4 border border-slate-600 two-cat-modal-content">
                <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 text-center">اختيار تصنيفين ✌️</h3>
                <p class="text-slate-300 text-center mb-6 text-sm sm:text-base">اختر تصنيفين فقط للمزج بينهما. الحد الأقصى للاختيار: 2</p>

                <div id="modalCategoriesGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <!-- Categories will be dynamically generated here -->
                </div>

                <div class="flex justify-between gap-4 mt-6 flex-shrink-0">
                    <button onclick="closeTwoCategoriesModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition-all">إلغاء</button>
                    <button onclick="confirmTwoCategories()" id="confirmCategoriesBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-all">تأكيد الاختيار</button>
                </div>
            </div>
        </div>

        <!-- Game Phase (All Sub-phases are children of this container) -->
        <div id="gamePhase" class="hidden">
           
            <!-- Role Distribution -->
            <div id="roleDistribution" class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl sm:text-3xl">🎭</span>
                    <span>توزيع الأدوار</span>
                </h2>
                <p class="text-slate-300 text-center mb-4 sm:mb-6 text-sm sm:text-base">اضغط على اسم كل لاعب لرؤية دوره (سراً)</p>
                <!-- NEW: Role Cards Color (Green/Teal/Cyan) -->
                <div id="roleCards" class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4"></div>
                 <!-- Spider-verse Button -->
                <div class="button-wrapper" onclick="showQuestions()">
                    <button class="spiderverse-button">
                        <span class="glitch-text">بدء جولة الأسئلة</span>
                        <div class="glitch-layers">
                            <div class="glitch-layer layer-1">بدء جولة الأسئلة</div>
                            <div class="glitch-layer layer-2">بدء جولة الأسئلة</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Questions Phase -->
            <div id="questionsPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl sm:text-3xl">❓</span>
                    <span>جولة الأسئلة - الجولة <span id="currentQuestionRound">1</span></span>
                </h2>
                <div id="currentQuestionContainer" class="mb-6">
                    <div class="question-turn-container">
                        <div class="player-turn-card asker">
                            <div class="card-icon-area">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <div class="card-text-area">
                                <div class="player-label">السائل</div>
                                <div id="askerName" class="player-name"></div>
                            </div>
                        </div>
                        <div class="asks-divider">يسأل</div>
                        <div class="player-turn-card answerer">
                            <div class="card-icon-area">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <div class="card-text-area">
                                <div class="player-label">المجيب</div>
                                <div id="answererName" class="player-name"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center text-slate-200 mt-4 text-base">
                        اطرح سؤالاً حول الكلمة السرية (بدون ذكرها مباشرة)
                    </div>
                </div>

                <div id="questionProgress" class="bg-slate-700 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 text-center border border-slate-600">
                    <div class="text-sm sm:text-base text-slate-300">تم طرح: <span id="askedCount" class="text-white font-bold">0</span> من <span id="totalQuestions" class="text-white font-bold">0</span> سؤال</div>
                </div>
                <div class="flex flex-col gap-4">
                    <button onclick="nextQuestion()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg text-lg flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        <span>السؤال التالي</span>
                    </button>
                    <button onclick="skipToOptional()" class="w-full bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg text-lg flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m5 4 10 8-10 8V4z"/><path d="M19 4v16"/></svg>
                        <span>للأسئلة الاختيارية</span>
                    </button>
                </div>
            </div>

            <!-- Optional Questions Phase -->
            <div id="optionalQuestionsPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <img src="https://i.postimg.cc/4yxdFbQH/image.png" class="w-8 h-8">
                    <span>جولة الأسئلة الاختيارية</span>
                </h2>
                <div id="optionalQuestionContainer" class="mb-6">
                    <div id="optionalQuestionInstructions" class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl p-6 sm:p-8 text-center shadow-lg min-h-[120px] flex items-center justify-center">
                        <div class="text-lg sm:text-xl text-slate-300">
                            هذه جولة إضافية لمن يريد أن يسأل. اضغط على "سؤال جديد" لتحديد من يسأل ومن يجيب بشكل عشوائي.
                        </div>
                    </div>
                    <!-- NEW Structure for optional turn -->
                    <div id="optionalQuestionTurn" class="question-turn-container hidden">
                         <div class="player-turn-card asker">
                            <div class="card-icon-area">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            </div>
                            <div class="card-text-area">
                                <div class="player-label">السائل</div>
                                <div id="optionalAskerName" class="player-name"></div>
                            </div>
                        </div>
                        <div class="asks-divider">يسأل</div>
                        <div class="player-turn-card answerer">
                            <div class="card-icon-area">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <div class="card-text-area">
                                <div class="player-label">المجيب</div>
                                <div id="optionalAnswererName" class="player-name"></div>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class="flex flex-col gap-4">
                    <button onclick="nextOptionalQuestion()" class="w-full bg-gradient-to-r from-sky-600 to-teal-600 hover:from-sky-700 hover:to-teal-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg text-lg flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                        <span>سؤال جديد</span>
                    </button>
                    <button onclick="proceedToVotingFromOptional()" class="w-full bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg text-lg flex items-center justify-center gap-3">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m5 4 10 8-10 8V4z"/><path d="M19 4v16"/></svg>
                         <span>الانتقال للتصويت</span>
                    </button>
                </div>
            </div>

            <!-- Voting Phase -->
            <div id="votingPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 mb-6 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <img src="https://i.postimg.cc/CLBW0n1Q/205-x-205.png" class="w-8 h-8">
                    <span>التصويت - الجولة <span id="currentRound">1</span></span>
                </h2>
                <div id="currentVoter" class="bg-gradient-to-r from-sky-600 to-teal-600 rounded-xl p-4 mb-4 sm:mb-6 text-center shadow-lg">
                    <div class="text-base sm:text-lg font-bold text-white">دور اللاعب: <span id="voterName"></span></div>
                    <div class="text-xs sm:text-sm text-sky-100 mt-1">اختر كل من تعتقد أنهم ملاقيف</div>
                </div>
                <div id="votingCards" class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6"></div>
                <button id="confirmVoteBtn" onclick="confirmVote()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                    تأكيد التحدي
                </button>
            </div>

            <!-- Reveal Phase (Re-added) -->
            <div id="revealPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl sm:text-3xl">🎰</span>
                    <span>كشف الملقوف</span>
                </h2>
                <div id="revealInitial" class="text-center mb-6 sm:mb-8">
                    <div class="text-base sm:text-lg text-slate-300 mb-4">انتهى التصويت! الآن سنكشف من هم الملاقيف...</div>
                    <button onclick="startReveal()" id="revealBtn" class="btn">
                        <span>اكشف!</span>
                    </button>
                </div>
               
                <!-- Name Spinning -->
                <div id="spinningWheel" class="hidden">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="text-lg sm:text-2xl font-bold text-red-400 mb-6 sm:mb-8 flex items-center justify-center gap-2">
                            <span class="text-2xl sm:text-3xl">🎰</span>
                            <span>قرعة الكشف</span>
                        </div>
                        <div class="spinning-wheel-container">
                            <div class="spinning-wheel-inner">
                                <div id="currentName"></div>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-6 text-base sm:text-lg text-slate-300 font-semibold animate-pulse flex items-center justify-center gap-2">
                            <span class="text-xl sm:text-2xl">🔄</span>
                            <span>الأسماء تدور...</span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Wesh Al Harja Phase (New) -->
            <div id="weshAlHarjaPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-2 text-center flex items-center justify-center gap-2">
                    <img src="https://i.postimg.cc/4yxdFbQH/image.png" class="w-8 h-8">
                    <span>وش الهرجة؟</span>
                </h2>
                <p id="weshAlHarjaInstructions" class="text-center text-slate-300 mb-6"></p>
                <div id="weshAlHarjaChoices" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Word choices will be populated here -->
                </div>
                <div id="weshAlHarjaResult" class="text-center mt-6 font-bold text-2xl"></div>
            </div>


            <!-- Results Phase -->
            <div id="resultsPhase" class="hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-4 sm:p-8 border border-slate-700">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl sm:text-3xl">🏆</span>
                    <span>النتائج</span>
                </h2>
                <div id="resultsContent"></div>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-4 sm:mt-6">
                    <button onclick="newRound()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white text-lg sm:text-xl font-bold py-4 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        <span class="text-xl sm:text-2xl">🔄</span>
                        <span>جولة جديدة</span>
                    </button>
                    <!-- NEW: New Game Button Gradient -->
                    <button onclick="handleResetConfirm()" class="flex-1 bg-gradient-to-r from-sky-600 to-teal-600 hover:from-sky-700 hover:to-teal-700 text-white text-lg sm:text-xl font-bold py-4 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        <span class="text-xl sm:text-2xl">🆕</span>
                        <span>لعبة جديدة</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Game State
        let players = [];
        let secretWord = '';
        let secretWordInfo = {}; // Will hold { word, categoryKey }
        let imposters = []; // Now an array of imposter names
        let votes = {}; // {votedPlayerName: count} -> No longer used for scoring, but good for display
        let playerVotes = {}; // {voterName: [selectedPlayers]} - NEW: stores the array of challenged players
        let revealedRoles = new Set();
        let lockedRoles = new Set();
        let playerScores = {};
        let roundNumber = 1;
        let currentVoterIndex = 0;
        let questionPairs = [];
        let currentQuestionIndex = 0;
        let impostersCount = 1; // Default imposter count
        let imposterSelectionMode = 'manual'; // 'manual', 'random', 'red_dice'
        const MAX_PLAYERS = 20;
        let imposterGuessedCorrectly = false; // Tracks if imposter team guessed the word
        let roundScores = {}; // To track scores for the current round only

        // Current selected category keys (supports single, double, or random)
        let selectedCategoryKeys = []; 
        let modalSelectedCategories = new Set();

        // --- History & Navigation Management (NEW) ---

        const mainViews = ['categoryPhase', 'setupPhase', 'gamePhase'];
        const allModals = ['settingsModal', 'confirmResetModal', 'confirmNewRoundModal', 'twoCategoriesModal', 'scoresModal', 'confirmScoreResetModal', 'howToPlayModal'];
        let currentState = {}; // Keep track of the current UI state

        // Updates the UI to match a given state object without pushing to history
        function updateUI(state) {
            if (!state || !state.view) {
                // Fallback to default state if history is empty or invalid
                state = { view: 'categoryPhase', modal: null };
            }
            currentState = state;

            // Handle main view visibility
            mainViews.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const targetView = document.getElementById(state.view);
            if (targetView) targetView.classList.remove('hidden');

            // Handle modal visibility
            allModals.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) modal.classList.add('hidden');
            });
            if (state.modal) {
                const targetModal = document.getElementById(state.modal);
                if (targetModal) targetModal.classList.remove('hidden');
            }
        }

        // Navigates to a new state and pushes it to the browser's history
        function navigateTo(newState) {
            // A simple check to prevent pushing identical consecutive states
            if (JSON.stringify(newState) === JSON.stringify(history.state)) return;
            history.pushState(newState, '');
            updateUI(newState);
        }

        // Listen for back/forward browser button clicks
        window.addEventListener('popstate', function(event) {
            updateUI(event.state);
        });

        // --- Save/Load Game State ---

        function saveGameState() {
            const gameState = {
                // players are now saved separately
                playerScores: playerScores
            };
            try {
                localStorage.setItem('malqoofGameState', JSON.stringify(gameState));
            } catch (e) {
                console.error('Failed to save game state:', e);
            }
        }

        function loadGameState() {
            try {
                const savedState = localStorage.getItem('malqoofGameState');
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    if (gameState && typeof gameState.playerScores === 'object') {
                        // players are loaded separately now
                        playerScores = gameState.playerScores;
                        // showLoadNotification(players.length); // Use players array length from loadPlayerNames
                    }
                }
            } catch (e) {
                console.error('Failed to load game state:', e);
                localStorage.removeItem('malqoofGameState');
            }
        }

        function savePlayerNames() {
            const playerInputs = document.querySelectorAll('#playersContainer .player-input');
            const names = Array.from(playerInputs).map(input => input.value.trim()); // Keep empty slots
            try {
                localStorage.setItem('malqoofPlayerNames', JSON.stringify(names));
            } catch (e) {
                console.error("Failed to save player names:", e);
            }
        }

        function loadPlayerNames() {
            try {
                const savedNames = localStorage.getItem('malqoofPlayerNames');
                if (savedNames) {
                    const names = JSON.parse(savedNames);
                    if (Array.isArray(names)) {
                        return names; // Return the array of names
                    }
                }
            } catch (e) {
                console.error('Failed to load player names:', e);
            }
            return []; // Return empty array if nothing found
        }
        
        function showLoadNotification(playerCount) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-green-600 text-white py-2 px-5 rounded-lg shadow-lg z-[2000] text-sm';
            notification.textContent = `تم استئناف الجلسة السابقة بـ ${playerCount} لاعبين!`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s ease';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function populatePlayersUI() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = ''; // Clear default inputs
            let namesToDisplay = loadPlayerNames();
            
            // Ensure there are at least 5 input fields for a good initial look
            while (namesToDisplay.length < 5) {
                namesToDisplay.push('');
            }

            namesToDisplay.forEach((name, index) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.oninput = () => { // save on input
                    updateMaxImposters();
                    savePlayerNames();
                };
                input.className = 'player-input w-full p-3 player-input-style';
                input.placeholder = `🎮 اللاعب ${index + 1}`;
                input.value = name;
                container.appendChild(input);
            });
            updateMaxImposters();
        }

        // Custom alert function to replace window.alert
        function customAlert(message) {
            if (document.querySelector('.custom-alert')) return;
            const backdrop = document.createElement('div');
            backdrop.className = 'custom-alert-backdrop';
            backdrop.onclick = closeCustomAlert;
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = `
                <div class="text-xl font-bold text-red-500 mb-3">⚠️ تنبيه</div>
                <p class="text-white text-base mb-4">${message}</p>
                <button onclick="closeCustomAlert()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-xl transition-colors">حسناً</button>
            `;
            document.body.appendChild(backdrop);
            document.body.appendChild(alertBox);
        }

        function closeCustomAlert() {
            const backdrop = document.querySelector('.custom-alert-backdrop');
            const alertBox = document.querySelector('.custom-alert');
            if (backdrop) backdrop.remove();
            if (alertBox) alertBox.remove();
        }


        // Word categories map
        const wordCategories = {
            foods: {
                name: 'الأطعمة',
                desc: 'أطعمة وأكلات شعبية وعالمية',
                emoji: '🍽️',
                words: [
                    'كبسة', 'شاورما', 'بيتزا', 'برجر', 'مندي', 'فلافل (طعمية)', 'سمبوسة', 'بطاطس مقلية',
                    'ورق عنب', 'حمص', 'باستا (مكرونة)', 'جريش', 'سليق', 'كنافة', 'آيس كريم', 
                    'دجاج مقلي (بروستد)', 'ستيك', 'كباب', 'خبز', 'أرز', 'معصوب', 'شوربة', 
                    'سلطة', 'بيض', 'جبن', 'تبولة', 'إندومي', 'بقلاوة', 'كيك', 'سوشي', 'مفطح', 
                    'عسل', 'زبادي', 'مرقوق', 'مقلوبة', 'فتوش', 'كبة', 'مطبق', 'فول', 'بليلة', 
                    'لقيمات', 'قطايف', 'برياني', 'مضغوط', 'منتو', 'يغمش', 'فرموزة', 'صيادية', 
                    'هوت دوج', 'نودلز', 'دونات', 'عريكة', 'مثلوثة', 'فتة', 'متبل', 'مشاوي', 
                    'تونة', 'جمبري', 'كرواسان', 'كورن فليكس', 'بان كيك', 'وافل', 'فشار', 
                    'مكسرات', 'شيبس', 'شوكولاتة', 'حلاوة طحينية', 'زبدة', 'مربى', 'قشطة', 
                    'كليجا', 'قرصان', 'عصيدة', 'بخاري', 'مصابيب', 'كبدة', 'مقلل', 
                    'ساندويتش', 'لازانيا', 'بودينغ', 'مهلبية', 'أم علي', 'بسبوسة', 'بسكويت', 
                    'كندر', 'مناقيش', 'فطيرة', 'فاهيتا', 'تاكو', 'ناجتس', 'كشري', 
                    'مسقعة', 'طاجن', 'سمك مشوي', 'سلطة سيزر', 'ثريد', 'فتة حمص', 'فطاير',
                    'مقليات', 'شيش طاووق', 'سلطة فواكه', 'تستيك', 'صيادية', 'مكرونة بشاميل',
                    'فتة باذنجان', 'فطاير سبانخ', 'مكرونة', 'دجاج مشوي', 'لحم مشوي', 'سوشي'
                ]
            },
            animals: {
                name: 'حيوانات ومخلوقات حية',
                desc: 'برية وبحرية وبرمائية وحتى الطيور',
                emoji: '🦁',
                words: [
                    'أسد', 'نمر', 'فيل', 'زرافة', 'حوت', 'قرش', 'دولفين', 'حصان', 'جمل', 'بقرة',
                    'خروف', 'كلب', 'قط', 'دجاجة', 'صقر', 'نسr', 'حمامة', 'قرد', 'غزال', 'ثعبان',
                    'تمساح', 'سلحفاة', 'ضفدع', 'فراشة', 'نحلة', 'نملة', 'عنكبوت', 'عقرب', 'أرنب', 'فأر',
                    'دب', 'ذئب', 'ثعلب', 'بطريق', 'نعامة', 'طاووس', 'ببغاء', 'كنغر', 'كوالا', 'باندا',
                    'وحيد القرن', 'فرس النهر', 'حمار وحشي', 'أخطبوط', 'حبار', 'نجمة البحر', 'قنديل البحر', 'سرطان', 'روبيان', 'محار',
                    'حرباء', 'بومة', 'sنجاب', 'قنفذ', 'سمكة', 'تونا', 'سلمون', 'فهد', 'ضبعة',
                    'خنزير', 'ماعز', 'بطة', 'بجعة', 'غراب', 'هدهد', 'نقار الخشب', 'فقمة', 'فرس البحر', 'دودة',
                    'حلزون', 'جرادة', 'صرصور', 'بعوضة', 'ذبابة', 'خنفساء', 'حمار', 'فلامنجو', 'كناري', 'عصفور',
                    'ديك', 'ديك رومي', 'غوريلا', 'ثور', 'هامستر', 'المها', 'طائر الطنان', 'محار', 'مرجان', 'قنفذ البحر',
                    'يرقة', 'دعسوقة', 'يعسوب', 'دبور', 'نورس', 'أوزة', 'لاما', 'راكون', 'ظبي', 'الحوت القاتل'
                ]
            },
            countries: {
                name: 'دول ومعالم',
                desc: 'من الكعبة إلى برج إيفل ومن السعودية إلى أقاصي الأرض',
                emoji: '🌍',
                words: [
                    'السعودية', 'الكعبة المشرفة', 'مصر', 'الأهرامات', 'الإمارات', 'برج خليفة', 'الكويت', 'برج الساعة', 'قطر', 'البحرين',
                    'سلطنة عمان', 'الأردن', 'برج المملكة', 'لبنان', 'مدائن صالح', 'سوريا', 'العراق', 'المغرب', 'فرنسا', 'برج إيفل',
                    'إيطاليا', 'برج بيزا المائل', 'بريطانيا', 'ساعة بيج بن', 'أمريكا', 'تمثال الحرية', 'البيت الأبيض', 'الصين', 'سور الصين العظيم', 'الهند',
                    'تاج محل', 'اليابان', 'تركيا', 'إسبانيا', 'سويسرا', 'ألمانيا', 'روسيا', 'البرازيل', 'كندا', 'أستراليا',
                    'كوريا الجنوبية', 'اليونان', 'هولندا', 'فلسطين', 'تونس', 'اليمن', 'نهر النيل', 'المالديف', 'جبل إيفرست', 'هوليوود'
                ]
            },
            produce: {
                name: 'فواكه وخضار',
                desc: 'من التفاح إلى البطاطس',
                emoji: '🥦',
                words: [
                    'تفاح', 'موز', 'برتقال', 'فراولة', 'عنب', 'مانجو', 'بطيخ', 'شمام', 'أناناس', 'كرز',
                    'خوخ', 'مشمش', 'كمثرى', 'رمان', 'توت', 'كيوي', 'ليمون', 'تمر', 'تين', 'جوافة',
                    'طماطم', 'خيار', 'جزر', 'بصل', 'ثوم', 'بطاطس', 'خس', 'فلفل رومي', 'باذنجان', 'كوسا',
                    'بقدونس', 'كزبرة', 'نعناع', 'سبانخ', 'بروكلي', 'قرنبيط', 'ملفوف', 'ذرة', 'فطر', 'بازلاء',
                    'فاصوليا', 'بامية', 'زنجبيل', 'شمندر', 'يقطين', 'أفوكادو', 'جوز الهند', 'زيتون', 'جرجير', 'يوسفي',
                    'بطاطا حلوة', 'ملوخية', 'فجل', 'بصل أخضر', 'فلفل حار', 'حبق', 'ريحان', 'زعتر', 'لوز', 'جوز',
                    'فستق', 'كاجو', 'فول سوداني', 'زبيب', 'عدس', 'حمص', 'فول', 'سمسم', 'بندق', 'صبار',
                    'قشطة', 'رطب', 'ليمون أخضر', 'فاصوليا خضراء', 'بازلاء خضراء', 'هيل', 'قرفة', 'كمون', 'كركم', 'زعفران',
                    'صنوبر', 'تمر هندي', 'كستناء', 'فاكهة التنين'
                ]
            },
            drinks: {
                name: 'المشروبات',
                desc: 'كل ما يشرب بارداً كان أو ساخن',
                emoji: '🥤',
                words: [
                    'ماء', 'شاي', 'قهوة', 'حليب', 'بيبسي', 'كوكاكولا', 'سفن أب', 'عصير برتقال', 'لبن', 'قهوة عربية',
                    'فيمتو', 'ليمون بالنعناع', 'شاي كرك', 'ميلك شيك', 'عصير مانجو', 'ريد بول', 'كابتشينو', 'سوبيا', 'عصير تفاح', 'قهوة تركية',
                    'شوكولاتة ساخنة', 'كركديه', 'تمر هندي', 'زنجبيل', 'ينسون', 'شاي أخضر', 'ميرندا', 'ديو', 'لاتيه', 'اسبريسو',
                    'عصير فراولة', 'كوكتيل', 'سحلب', 'مياه غازية', 'شاي عدني', 'أمريكانو', 'موكا', 'فرابتشينو', 'كودرد', 'شاي بالحليب',
                    'عصير رمان', 'بيرة شعير', 'كينزا', 'قمر الدين', 'قهوة فرنسية', 'عصير جزر', 'عصير بطيخ', 'حليب بالشوكولاتة', 'آيس تي', 'فانتا',
                    'سبرايت', 'شاني', 'حمضيات', 'عصير عنب', 'عصير أناناس', 'عصير جوافة', 'ماء جوز الهند', 'سبانيش لاتيه', 'فلات وايت', 'مكياتو',
                    'كولد برو', 'ماتشا', 'موهيتو', 'بابونج', 'شاي مغربي', 'حليب بالزنجبيل', 'حليب بالفراولة', 'حليب بالموز', 'قهوة مقطرة', 'شاي إنجليزي',
                    'عصير كيوي', 'عصير ليمون', 'كراميل مكياتو', 'وايت موكا', 'قهوة لوز', 'حليب لوز', 'حليب صويا', 'V60', 'عصير خوخ', 'تانج برتقال',
                    'حليب نياق', 'سلاش', 'توت'
                ]
            },
            clothing: {
                name: 'ملابس',
                desc: 'متنوعة وعالمية',
                emoji: '👚',
                words: [
                    'ثوب', 'شماغ', 'عباية', 'بنطلون', 'قميص', 'تيشيرت', 'فستان', 'جينز', 'حذاء', 'جاكيت',
                    'عقال', 'غترة', 'طاقية', 'طرحة', 'ثوب نوم', 'بشت', 'تنورة', 'شورت', 'بلوزة', 'ثوب شتوي',
                    'معطف', 'بدلة رسمية', 'بيجامة', 'شراب', 'حزام', 'قبعة', 'كعب', 'صندل', 'شبشب', 'حذاء رياضي',
                    'نقاب', 'سديري', 'ربطة عنق', 'وشاح', 'قفازات', 'هودي', 'ملابس داخلية', 'ملابس رياضية', 'جزمة', 'شنطة',
                    'نظارات شمسية', 'ساعة', 'فنيلة', 'سروال', 'روب الحمام', 'كروكس', 'زنوبة', 'شرقي', 'سروال سنة', 'فنيلة داخلية',
                    'فنيلة علاقي', 'خاتم', 'كبك', 'قفازات', 'نظارات'
                ]
            },
            places: {
                name: 'أماكن عامة',
                desc: 'من المطعم إلى المطار',
                emoji: '📍',
                words: [
                    'مستشفى', 'مدرسة', 'مطعم', 'مسجد', 'سوق', 'مطار', 'فندق', 'حديقة', 'شاطئ بحر', 'مول (مجمع تجاري)',
                    'بقالة', 'صيدلية', 'بنك', 'جامعة', 'مقهى', 'ملعب', 'محطة بنزين', 'بيت (منزل)', 'شارع', 'جسر',
                    'مركز شرطة', 'مكتبة', 'متحف', 'مخبز', 'سينما', 'نادي رياضي', 'مسبح', 'ملاهي', 'كورنيش', 'بر (صحراء)',
                    'استراحة', 'شقة', 'عمارة', 'مصنع', 'مزرعة', 'ميناء', 'محكمة', 'دفاع مدني', 'صالون حلاقة', 'مغسلة ملابس',
                    'ورشة سيارات', 'محطة قطار', 'نفق', 'دوار', 'مجلس', 'مخيم', 'مستوصف', 'محل', 'مصلى', 'موقف سيارات',
                    'حديقة حيوان', 'مركز تسوق'
                ]
            },
            professions: {
                name: 'مهن ووظائف',
                desc: 'من الطبيب إلى رائد الفضاء',
                emoji: '👨‍⚕️',
                words: [
                    'طبيب', 'مهندس', 'معلم', 'طيار', 'شرطي', 'طباخ (شيف)', 'نجار', 'جندي (عسكري)', 'ممرض', 'صيدلي',
                    'لاعب كرة قدم', 'مبرمج', 'مصمم', 'رسام', 'ممثل', 'مغني', 'مذيع', 'صحفي', 'مصور', 'محامي',
                    'قاضي', 'إمام مسجد', 'مؤذن', 'سائق', 'ميكانيكي', 'كهربائي', 'سباك', 'بناء (عامل بناء)', 'حلاق', 'خباز',
                    'جزار', 'خياط', 'بائع', 'مدير', 'محاسب', 'رجل إطفاء', 'عالم', 'باحث', 'كاتب', 'مزارع',
                    'صياد', 'طبيب بيطري', 'طبيب أسنان', 'مدرب رياضي', 'موظف استقبال', 'حارس أمن', 'ساعي بريد', 'عامل نظافة', 'مرشد سياحي', 'مضيف طيران',
                    'قبطان (ربان سفينة)', 'رائد فضاء', 'خبير تجميل', 'صائغ', 'بستاني (جنايني)', 'خطاط', 'مترجم', 'إداري', 'باريستا (صانع قهوة)', 'دهان (صباغ)',
                    'رجل أعمال', 'موظف بنك', 'صانع أحذية', 'غواص', 'لحام', 'مدقق حسابات', 'أمين مكتبة', 'نادل (جرسون)', 'طاهي حلويات', 'فنان',
                    'جراح', 'مخرج', 'مؤلف', 'سكرتير', 'عامل توصيل', 'مسعف', 'منقذ', 'أخصائي تغذية', 'مستشار', 'مدير مشروع',
                    'وسيط عقاري', 'مراقب جوي', 'معالج فيزيائي', 'صانع محتوى', 'مدير مدرسة', 'محاضر جامعي', 'منتج', 'مهندس صوت', 'طبيب نفسي', 'فني مختبر',
                    'موظف خدمة عملاء', 'منسق فعاليات', 'محلل بيانات', 'مسوق إلكتروني', 'مدرب شخصي', 'عارض أزياء', 'مطور ألعاب', 'وكيل سفر', 'عالم آثار', 'خبير اقتصادي'
                ]
            },
            sports_games: {
                name: 'رياضة وألعاب',
                desc: 'من كرة القدم إلى الشطرنج',
                emoji: '⚽',
                words: [
                    'كرة قدم', 'كرة سلة', 'كرة طائرة', 'كرة يد', 'تنس', 'سباحة', 'جري', 'ملاكمة', 'مصارعة', 'كاراتيه', 'تايكوندو', 'جودو', 'رفع أثقال', 'كمال أجسام', 'جمباز', 'سباق سيارات', 'فورمولا 1', 'رالي', 'دراجات هوائية', 'فروسية (ركوب الخيل)', 'قفز حواجز', 'غولف', 'بلياردو', 'بولينج', 'شطرنج', 'بلوت', 'كيرم', 'ضومنة (دومينو)', 'ورق (لعبة شدة)', 'تنس طاولة (بنج بونج)', 'ريشة طائرة', 'هوكي الجليد', 'تزلج على الجليد', 'تزلج على اللوح', 'ركوب الأمواج', 'غوص', 'صيد السمك', 'رماية', 'القوس والسهم (نبالة)', 'ماراثون', 'تسلق الجبال', 'كرة قدم أمريكية', 'بيسبول', 'كريكيت', 'رجبي', 'كرة الماء', 'التجديف', 'اليوغا', 'الباليه', 'الكلمات المتقاطعة', 'سودوكو', 'أتاري', 'بلايستيشن', 'إكس بوكس', 'نينتندو', 'لعبة الحبار', 'المونوبولي', 'لعبة السلم والثعبان', 'فرفيرة (بيبي فوت)', 'هوكي الهواء', 'سهام (دارتس)', 'المصاقيل (البلي)', 'الكيرم الهندي', 'الكابادي', 'ألعاب القوى', 'رمي الرمح', 'رمي القرص', 'قفز طويل', 'قفز عالي', 'المشي', 'التزلج بالعجلات', 'الباركور', 'المبارزة بالسيف', 'كرة الريشة', 'البينتبول', 'الكارتينج', 'الشطرنج الصيني', 'الأونو', 'جاكارو', 'الداما', 'إكس أو (XO)', 'حجر، ورقة، مقص', 'الغميضة', 'القفز على الحبل', 'كرة الطائرة الشاطئية', 'كرة القدم الخماسية', 'البوتشي', 'الترايثلون', 'الكروكيه', 'سباق الخيل', 'سباق الهجن', 'الفنون القتالية المختلطة (MMA)', 'الكيك بوكسينغ', 'السومو', 'بولو', 'التزلج على الماء', 'الطيران الشراعي', 'ألعاب الفيديو', 'لعبة الألغاز', 'الكوتشينة'
                ]
            },
            brands: {
                name: 'ماركات وعلامات تجارية',
                desc: 'من آبل إلى البيك',
                emoji: '🛍️',
                words: [
                    'تويوتا', 'آبل', 'سامسونج', 'البيك', 'المراعي', 'ماكدونالدز', 'نايكي', 'أديداس', 'بيبسي', 'كوكاكولا', 'بندة', 'جرير', 'STC', 'كنتاكي (KFC)', 'سوني (بلايستيشن)', 'هيونداي', 'الخطوط السعودية', 'نادك', 'سابك (SABIC)', 'أرامكو', 'غوتشي', 'شانيل', 'رولكس', 'مرسيدس', 'فورد', 'لكزس', 'جوجل', 'مايكروسوفت (ويندوز)', 'هواوي', 'إيكيا', 'زارا (Zara)', 'إتش آند إم (H&M)', 'سنتربوينت', 'هرفي', 'كودو', 'العثيم', 'الدانوب', 'إكسترا', 'ساكو', 'هوم سنتر', 'ستاربكس', 'دانكن', 'بارنز (بارن كافيه)', 'برجر كنج', 'بيتزا هت', 'دومينوز بيتزا', 'ليز (Lays)', 'كت كات (KitKat)', 'جالكسي', 'سنيكرز', 'صابون لوكس', 'نيفيديا', 'هيد آند شولدرز', 'سيجنال (Signal)', 'العربية للعود', 'لويس فيتون (LV)', 'ديور (Dior)', 'بوما (Puma)', 'سكيتشرز', 'طيران ناس', 'طيران الإمارات', 'موبايلي', 'زين', 'الصافي', 'قودي (Goody)', 'ماجي (Maggi)', 'ليبتون', 'الربيع', 'آيسكريم السعودية', 'جمس (GMC)', 'شيفروليه', 'نيسان', 'LG', 'فيراري', 'لامبورجيني', 'ديزني', 'ليغو (Lego)', 'تويز آر أص', 'كارفور', 'لولو هايبر ماركت', 'الفالح', 'الشمس والرمال للرياضة', 'سيفورا (Sephora)', 'ردتاغ', 'ماكس (Max)', 'برنامج رحال', 'مذركير', 'نيستلا', 'بامبرز', 'ديتول', 'فيزا (Visa)', 'ماستركارد (Mastercard)', 'أمازون', 'نتفليكس', 'يوتيوب', 'تيك توك', 'سناب شات', 'فيسبوك', 'تويتر (إكس)', 'واتساب'
                ]
            },
            quran_surahs: {
                name: 'سور من القرآن',
                desc: 'من الفاتحة إلى الناس',
                emoji: '📖',
                words: [
                    'الأنفال', 'الماعون', 'الحديد', 'فاطر', 'الواقعة', 'الشورى', 'البينة', 'الحاقة', 'الزلزلة', 'غافر',
                    'الممتحنة', 'الجن', 'الزمر', 'النصر', 'الشمس', 'البلد', 'ص', 'محمد', 'المائدة', 'الفلق',
                    'نوح', 'الأحقاف', 'الرعد', 'يونس', 'القلم', 'النور', 'النمل', 'التحريم', 'التكاثر', 'الأعلى',
                    'الكافرون', 'القارعة', 'التغابن', 'الفتح', 'الأنعام', 'البروج', 'الكوثر', 'العنكبوت', 'الحجرات', 'الإخلاص',
                    'مريم', 'يوسف', 'لقمان', 'المنافقون', 'المزمل', 'الرحمن', 'قريش', 'الأحزاب', 'الفيل', 'الليل',
                    'الجمعة', 'آل عمران', 'الناس', 'النساء', 'العاديات', 'القدر', 'الانشقاق', 'إبراهيم', 'البقرة', 'العصر',
                    'المجادلة', 'المدثر', 'النجم', 'الصافات', 'الإنسان', 'الحشر', 'القمر', 'ق', 'الطلاق', 'العلق',
                    'الانفطار', 'الذاريات', 'عبس', 'الحجر', 'المؤمنون', 'القيامة', 'التوبة', 'الشعراء', 'الفاتحة', 'القصص',
                    'الهمزة', 'الشرح', 'سبأ', 'الملك', 'الطور', 'الروم', 'هود', 'فصلت', 'الكهف', 'الإسراء',
                    'النحل', 'طه', 'الأنبياء', 'الحج', 'الفرقان', 'السجدة', 'يس', 'الزخرف', 'الدخان', 'الجاثية',
                    'المعارج', 'المرسلات', 'النبأ', 'النازعات', 'التكوير', 'المطففين', 'الطارق', 'الغاشية', 'الفجر', 'الضحى',
                    'التين', 'الصف', 'المسد', 'الأعراف'
                ]
            },
            quran_characters: {
                name: 'شخصيات من القرآن',
                desc: 'من آدم إلى محمد (ﷺ)',
                emoji: '📖',
                words: [
                    'محمد (ﷺ)', 'عيسى', 'موسى', 'إبراهيم', 'نوح', 'يوسف', 'آدم', 'سليمان', 'داود', 'يونس', 'يعقوب', 'إسماعيل', 'صالح', 'هود', 'مريم العذراء', 'جبريل', 'فرعون', 'هارون', 'زكريا', 'يحيى', 'شعيب', 'آسيا (امرأة فرعون)', 'لقمان الحكيم', 'الخضر', 'ذو القرنين', 'قارون', 'هامان', 'جالوت', 'طالوت', 'بلقيس (ملكة سبأ)', 'عمران (والد مريم)', 'قابيل', 'هابيل', 'إبليس (الشيطان)', 'السامري', 'النمرود', 'عزيز مصر', 'إلياس', 'اليسع', 'ذو الكفل', 'إدريس', 'إسحاق', 'أيوب', 'ميكائيل', 'إسرافيل', 'ملك الموت', 'هاروت وماروت', 'قوم عاد', 'قوم ثمود', 'بنو إسرائيل', 'أهل مدين', 'قوم لوط', 'أصحاب الكهف', 'أصحاب الفيل', 'يأجوج ومأجوج', 'قريش', 'عزير'
                ]
            },
            sahaba: {
                name: 'الصحابة الكرام',
                desc: 'من الخلفاء الراشدين إلى الصحابيات',
                emoji: '🕋',
                words: [
                    'أبو بكر الصديق', 'عمر بن الخطاب', 'عثمان بن عفان', 'علي بن أبي طالب', 'خالد بن الوليد', 'أبو عبيدة بن الجراح', 'سعد بن أبي وقاص', 'عبدالرحمن بن عوف', 'طلحة بن عبيدالله', 'الزبير بن العوام', 'حمزة بن عبدالمطلب', 'بلال بن رباح', 'سلمان الفارسي', 'أبو هريرة', 'معاذ بن جبل', 'عبدالله بن مسعود', 'عبدالله بن عمر', 'عبدالله بن عباس', 'أنس بن مالك', 'مصعب بن عمير', 'جعفر بن أبي طالب', 'أبو ذر الغفاري', 'عمار بن ياسر', 'صهيب الرومي', 'زيد بن حارثة', 'أسامة بن زيد', 'الحسن بن علي', 'الحسين بن علي', 'أبو أيوب الأنصاري', 'سعد بن معاذ', 'عمرو بن العاص', 'عبدالله بن الزبير', 'أبو موسى الأشعري', 'أبو الدرداء', 'حسان بن ثابت', 'العباس بن عبدالمطلب', 'خباب بن الأرت', 'الأرقم بن أبي الأرقم', 'سعيد بن زيد', 'عكرمة بن أبي جهل', 'خديجة بنت خويلد', 'عائشة بنت أبي بكر', 'فاطمة الزهراء', 'حفصة بنت عمر', 'أم سلمة', 'زينب بنت جحش', 'صفية بنت حيي', 'سمية بنت خياط', 'أسماء بنت أبي بكر', 'وحشي بن حرب'
                ]
            }
        };
       
        // --- Mapping of Categories to their Image URLs (Extracted from HTML) ---
        // Desktop Images (Default)
        const categoryImages = {
            foods: 'https://i.postimg.cc/7Ly0r7nv/image.png',
            animals: 'https://i.postimg.cc/C5ZWDdrQ/7.png',
            countries: 'https://i.postimg.cc/D0WtsmpH/8.png',
            produce: 'https://i.postimg.cc/zXn1ktkH/9.png',
            drinks: 'https://i.postimg.cc/Y04JgjDP/6.png',
            clothing: 'https://i.postimg.cc/65dNhjhC/10.png',
            places: 'https://i.postimg.cc/8cFqWsn1/11.png',
            professions: 'https://iili.io/KhAdhGa.png',
            sports_games: 'https://iili.io/KhAdOaR.png',
            brands: 'https://iili.io/KhAdj6J.png',
            quran_characters: 'https://iili.io/KhAdkyN.png',
            sahaba: 'https://iili.io/KhAdevp.png',
            quran_surahs: 'https://iili.io/KhAdN3v.png',
            twoCategories: 'https://i.postimg.cc/vT1p9DS8/12.png',
            random: 'https://i.postimg.cc/J0y9JtYT/13.png',
        };

        // Mobile Images (Only used as CSS background override for main selection cards)
        const categoryImagesMobile = {
            foods: 'https://i.postimg.cc/cJNBWR9m/5.png',
            animals: 'https://i.postimg.cc/Qd7Jv4b0/7.png',
            countries: 'https://i.postimg.cc/Qd7Jv4bm/8.png',
            produce: 'https://i.postimg.cc/sgW4b6cK/9.png',
            drinks: 'https://i.postimg.cc/Pr9M3s1c/6.png',
            clothing: 'https://i.postimg.cc/rw4N7nJJ/10.png',
            places: 'https://i.postimg.cc/W4PwVGWw/11.png',
            professions: 'https://i.postimg.cc/2SQw5Bcb/14.png',
            sports_games: 'https://i.postimg.cc/9Qdpfq8r/12.png',
            brands: 'https://i.postimg.cc/XYf8vyHB/15.png',
            quran_characters: 'https://i.postimg.cc/QdQbMW43/17.png',
            sahaba: 'https://i.postimg.cc/BvJCPQkt/16.png',
            quran_surahs: 'https://i.postimg.cc/2SQw5Bcq/13.png',
            twoCategories: 'https://i.postimg.cc/YSwz76nx/12.png',
            random: 'https://i.postimg.cc/yNzyKmQX/13.png',
        };

        // --- Category Selection Logic ---

        function updateCategoryCounts() {
            // Recalculate total words for 'random' category
            let totalWords = 0;
            // Iterate over actual word categories only, skipping meta-categories
            const wordCategoryKeys = Object.keys(wordCategories).filter(key => wordCategories[key].words);
           
            wordCategoryKeys.forEach(key => {
                totalWords += wordCategories[key].words.length;
            });

            // Recalculate max words for 'twoCategories' button (largest possible combination)
            let maxWordsTwoCategories = 0;
            for (let i = 0; i < wordCategoryKeys.length; i++) {
                for (let j = i + 1; j < wordCategoryKeys.length; j++) {
                    const count = wordCategories[wordCategoryKeys[i]].words.length + wordCategories[wordCategoryKeys[j]].words.length;
                    if (count > maxWordsTwoCategories) {
                        maxWordsTwoCategories = count;
                    }
                }
            }
        }

        // Call once on load
        updateCategoryCounts();


        function selectCategory(categoryKey) {
           
            if (categoryKey === 'random') {
                // Select all actual word categories
                selectedCategoryKeys = Object.keys(wordCategories).filter(key => wordCategories[key].words);
            } else if (categoryKey === 'twoCategories') {
                return;
            } else {
                 selectedCategoryKeys = [categoryKey];
            }
           
            // Hide category selection and show setup
            navigateTo({ view: 'setupPhase', modal: null });
            populatePlayersUI(); // Call this to fill in saved players if they exist

            // Update selected category display, passing the specific key or 'random'
            updateSelectedCategoryDisplay(categoryKey);
        }

        function generateRandomWordFromCategory() {
            let wordWithCategory = []; // To store {word, categoryKey}
           
            let keysToUse = selectedCategoryKeys;
            if (keysToUse.length === 0) {
                keysToUse = Object.keys(wordCategories).filter(key => wordCategories[key].words);
            }

            // Create a list of objects, each containing a word and its original category key
            keysToUse.forEach(key => {
                if (wordCategories[key] && wordCategories[key].words) {
                    wordCategories[key].words.forEach(word => {
                        wordWithCategory.push({ word: word, categoryKey: key });
                    });
                }
            });

            if (wordWithCategory.length === 0) {
                return { word: "خطأ في الكلمات", categoryKey: null };
            }

            const randomIndex = Math.floor(Math.random() * wordWithCategory.length);
            return wordWithCategory[randomIndex];
        }

        function goBackToCategories() {
            history.back();
        }

        function updateSelectedCategoryDisplay(sourceKey) {
            const selectedCategoryEl = document.getElementById('selectedCategory');
           
            if (selectedCategoryKeys.length === 0) {
                selectedCategoryEl.innerHTML = `<div class="font-bold text-white text-base sm:text-lg">الرجاء اختيار تصنيف أولاً</div>`;
                return;
            }

            let title = '';
            let subtitle = '';
            let imageKey = sourceKey; 

            if (selectedCategoryKeys.length > 1 && sourceKey !== 'random') {
                // Two categories selected via modal (Use 'twoCategories' meta key)
                const names = selectedCategoryKeys.map(key => wordCategories[key].name).join(' و ');
                title = `التصنيف المختار: ${names}`;
                subtitle = 'سيتم اختيار كلمة عشوائية من كلا التصنيفين';
                imageKey = 'twoCategories'; // Use the dedicated image for two categories
            } else if (sourceKey === 'random' || selectedCategoryKeys.length === Object.keys(wordCategories).filter(key => wordCategories[key].words).length) {
                // Random selected
                title = 'التصنيف المختار: مختلط عشوائي (كل شيء)';
                subtitle = 'سيتم اختيار كلمة عشوائية من جميع التصنيفات';
                imageKey = 'random'; // Use the dedicated image for random
            } else {
                // Single category selected
                const category = wordCategories[selectedCategoryKeys[0]];
                title = `التصنيف المختار: ${category.name}`;
                subtitle = 'سيتم اختيار كلمة عشوائية من هذا التصنيف';
                imageKey = selectedCategoryKeys[0]; // Use the specific category image
            }

            // FIX: Always use the DESKTOP image map for the Selected Category Display (Goal 2 Fix)
            const selectedImage = categoryImages[imageKey] || 'URL_NOT_FOUND';


            const displayHTML = `
                <div class="selected-category-image-bg" style="background-image: url('${selectedImage}');">
                    <div class="selected-category-content-overlay">
                        <div class="selected-category-title">${title}</div>
                        <div class="selected-category-subtitle">${subtitle}</div>
                        <button onclick="goBackToCategories()" class="change-category-btn animated-button" style="width: fit-content; margin: 8px auto 0;">
                            <div class="circle"></div>
                            <span class="text">تغيير التصنيف</span>
                            <svg viewBox="0 0 512 512" class="animated-icon arr-1">
                                <path d="M166.4 86.8c11-13.6 30.6-15.5 44.2-4.5l141.2 114.7c13.6 11 15.5 30.6 4.5 44.2l-141.2 114.7c-11 13.6-30.6 15.5-44.2 4.5s-15.5-30.6-4.5-44.2L278.4 256 161.9 140.9c-11-13.6-9.1-33.2 4.5-44.2z"></path>
                            </svg>
                            <svg viewBox="0 0 512 512" class="animated-icon arr-2">
                                <path d="M166.4 86.8c11-13.6 30.6-15.5 44.2-4.5l141.2 114.7c13.6 11 15.5 30.6 4.5 44.2l-141.2 114.7c-11 13.6-30.6 15.5-44.2 4.5s-15.5-30.6-4.5-44.2L278.4 256 161.9 140.9c-11-13.6-9.1-33.2 4.5-44.2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
           
            selectedCategoryEl.innerHTML = displayHTML;
        }

        // --- Imposter Count Logic ---

        function updateMaxImposters() {
            const currentPlayers = Array.from(document.querySelectorAll('.player-input'))
                .map(input => input.value.trim())
                .filter(name => name !== '').length;
           
            // CHANGED: Max imposters is now players - 1
            const maxAllowed = Math.max(1, currentPlayers - 1); 
           
            if (impostersCount > maxAllowed) {
                impostersCount = maxAllowed;
                if (imposterSelectionMode === 'manual') {
                    document.getElementById('impostersCountDisplay').textContent = impostersCount;
                }
            }

            document.getElementById('imposterCountHint').textContent = `الحد الأقصى: ${maxAllowed > 0 ? maxAllowed : 1}`;
            return maxAllowed;
        }
        
        function setImposterMode(mode, change = 0) {
            if (mode === 'manual') {
                if (imposterSelectionMode !== 'manual') {
                    imposterSelectionMode = 'manual';
                }
                const maxAllowed = updateMaxImposters();
                let currentCount = impostersCount + change;
                if (currentCount > 0 && currentCount <= maxAllowed) {
                    impostersCount = currentCount;
                }
            } else {
                if (imposterSelectionMode === mode) {
                    imposterSelectionMode = 'manual'; // Toggle off
                } else {
                    imposterSelectionMode = mode;
                }
            }
            updateImposterCountUI();
        }

        function updateImposterCountUI() {
            const display = document.getElementById('impostersCountDisplay');
            const minusBtn = document.querySelector('.button-3d-minus');
            const plusBtn = document.querySelector('.button-3d-plus');
            const randomBtn = document.getElementById('randomImposterBtn');
            const redDiceBtn = document.getElementById('redDiceBtn');

            // Reset all states
            minusBtn.classList.remove('disabled');
            plusBtn.classList.remove('disabled');
            randomBtn.classList.remove('active');
            redDiceBtn.classList.remove('active');

            if (imposterSelectionMode === 'manual') {
                display.innerHTML = impostersCount;
            } else if (imposterSelectionMode === 'random') {
                display.innerHTML = '<img src="https://i.postimg.cc/7hZ6QMnT/image.png" class="w-6 h-6 mx-auto">';
                minusBtn.classList.add('disabled');
                plusBtn.classList.add('disabled');
                randomBtn.classList.add('active'); // Use 'active' for consistency
            } else if (imposterSelectionMode === 'red_dice') {
                display.innerHTML = '<img src="https://i.postimg.cc/FzHRngVS/image.png" class="w-6 h-6 mx-auto">';
                minusBtn.classList.add('disabled');
                plusBtn.classList.add('disabled');
                redDiceBtn.classList.add('active');
            }
        }

        // --- Player Setup Logic ---

        function addPlayer() {
            const container = document.getElementById('playersContainer');
            const currentCount = container.children.length;
           
            if (currentCount >= MAX_PLAYERS) {
                customAlert(`الحد الأقصى للاعبين هو ${MAX_PLAYERS} لاعب.`);
                return;
            }

            const input = document.createElement('input');
            input.type = 'text';
            input.oninput = updateMaxImposters;
            input.className = 'player-input w-full p-3 player-input-style';
            input.placeholder = `🎮 اللاعب ${currentCount + 1}`;
            container.appendChild(input);
            updateMaxImposters();
        }

        // --- Game Start & Setup ---

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function startGame() {
            if (selectedCategoryKeys.length === 0) {
                 customAlert('الرجاء اختيار تصنيف واحد على الأقل قبل بدء اللعبة.');
                 return;
            }

            const playerInputs = document.querySelectorAll('.player-input');
            players = Array.from(playerInputs)
                .map(input => input.value.trim())
                .filter(name => name !== '');
            
            savePlayerNames();

            if (players.length < 3) {
                customAlert('يجب أن يكون هناك على الأقل 3 لاعبين لبدء اللعبة!');
                return;
            }
            
            // Re-validate imposter count after finalizing players
            const maxPossible = updateMaxImposters();
            if (imposterSelectionMode === 'manual' && impostersCount > maxPossible) {
                 customAlert(`عدد الملاقيف يتجاوز الحد المسموح به (${maxPossible}).`);
                 return;
            }
            
            let finalImposterCount = impostersCount;
            if (imposterSelectionMode === 'random') {
                const playerCount = players.length;
                let min = 1, max = 1;
                if (playerCount <= 5) { min = 1; max = 2; }
                else if (playerCount <= 8) { min = 1; max = 3; }
                else { min = 2; max = 5; }
                max = Math.min(max, maxPossible);
                min = Math.min(min, max);
                finalImposterCount = Math.floor(Math.random() * (max - min + 1)) + min;
            } else if (imposterSelectionMode === 'red_dice') {
                const min = 1;
                const max = maxPossible;
                finalImposterCount = Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            // Generate random word
            secretWordInfo = generateRandomWordFromCategory();
            secretWord = secretWordInfo.word;
           
            // Choose random imposters
            const shuffledPlayers = shuffleArray(players);
            imposters = shuffledPlayers.slice(0, finalImposterCount);

            // Initialize player scores if first game
            players.forEach(player => {
                if (!(player in playerScores)) {
                    playerScores[player] = 0;
                }
            });

            // Reset game state
            votes = {};
            revealedRoles.clear();
            lockedRoles.clear();
            questionPairs = [];
            currentQuestionIndex = 0;
           
            // Show game phase
            navigateTo({ view: 'gamePhase', modal: null });
            
            // Show the first sub-phase
            document.getElementById('roleDistribution').classList.remove('hidden');
            document.getElementById('questionsPhase').classList.add('hidden');
            document.getElementById('optionalQuestionsPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('revealPhase').classList.add('hidden');
            document.getElementById('weshAlHarjaPhase').classList.add('hidden');
            document.getElementById('resultsPhase').classList.add('hidden');

            createRoleCards();
        }

        // --- Role Distribution Logic ---

        function createRoleCards() {
            const container = document.getElementById('roleCards');
            container.innerHTML = '';

            players.forEach(player => {
                const card = document.createElement('div');
                // NEW: Role Cards - Blue/Cyan Gradient 
                card.className = 'bg-gradient-to-br from-sky-600 to-teal-700 text-white p-4 sm:p-6 rounded-xl cursor-pointer transform hover:scale-105 transition-all shadow-lg border border-sky-400 hover:border-teal-400';
                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-xl sm:text-2xl mb-2"><img src="https://i.postimg.cc/cCLH5MBY/image.png" class="w-8 h-8 inline-block"></div>
                        <div class="font-bold text-base sm:text-lg">${player}</div>
                        <div class="text-xs sm:text-sm opacity-80 mt-2">اضغط لرؤية الدور</div>
                    </div>
                `;
                card.onclick = () => revealRole(player, card);
                container.appendChild(card);
            });
        }

        function revealRole(player, card) {
            // If locked, do nothing
            if (lockedRoles.has(player)) return;
           
            const isImposter = imposters.includes(player);
           
            // If already revealed, lock it
            if (revealedRoles.has(player)) {
                lockedRoles.add(player);
               
                card.className = 'bg-gradient-to-br from-gray-600 to-gray-800 text-white p-4 sm:p-6 rounded-xl shadow-lg cursor-not-allowed border border-gray-500';
                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl sm:text-3xl mb-2 sm:mb-3"><img src="https://i.postimg.cc/vHdzN4p2/image.png" class="w-8 h-8 inline-block"></div>
                        <div class="font-bold text-base sm:text-lg mb-2">${player}</div>
                        <div class="text-xs sm:text-sm opacity-80">مقفل - تم عرض الدور</div>
                    </div>
                `;
                return;
            }
           
            // First time reveal
            revealedRoles.add(player);
           
            card.className = isImposter 
                ? 'bg-gradient-to-br from-red-500 to-red-700 text-white p-4 sm:p-6 rounded-xl shadow-lg cursor-pointer border border-red-400'
                // NEW: Regular player card gradient
                : 'bg-gradient-to-br from-emerald-500 to-green-700 text-white p-4 sm:p-6 rounded-xl shadow-lg cursor-pointer border border-emerald-400';
           
            card.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl sm:text-3xl mb-2 sm:mb-3">${isImposter ? '<img src="https://i.postimg.cc/nL9N2tgc/image.png" class="w-8 h-8 mx-auto">' : '<img src="https://i.postimg.cc/2y96pb0q/image.png" class="w-8 h-8 mx-auto">'}</div>
                    <div class="font-bold text-base sm:text-lg mb-2">${player}</div>
                    <div class="text-base sm:text-lg font-semibold mb-2">
                        ${isImposter ? 'الملقوف!' : secretWord}
                    </div>
                    <div class="text-xs sm:text-sm opacity-90 mb-2">
                        ${isImposter ? 'حاول أن تخمن الكلمة!' : 'اكتشف الملقوف!'}
                    </div>
                    <div class="text-xs opacity-75 bg-black/20 rounded px-2 py-1">
                        اضغط مرة أخرى للإقفال
                    </div>
                </div>
            `;
        }

        // --- Question Phase Logic ---

        function showQuestions() {
            document.getElementById('roleDistribution').classList.add('hidden');
            document.getElementById('questionsPhase').classList.remove('hidden');
           
            // Generate question pairs - each player asks and gets asked once
            generateQuestionPairs();
           
            // Update round number and progress
            document.getElementById('currentQuestionRound').textContent = roundNumber;
            document.getElementById('totalQuestions').textContent = questionPairs.length;
            document.getElementById('askedCount').textContent = '0';
           
            // Reset question index
            currentQuestionIndex = 0;
           
            showNextQuestionPair();
        }

        function generateQuestionPairs() {
            questionPairs = [];
           
            // Simple approach: each player asks the next player in a circular manner
            for (let i = 0; i < players.length; i++) {
                const asker = players[i];
                const answerer = players[(i + 1) % players.length];
                questionPairs.push({ asker, answerer });
            }
           
            // Shuffle the pairs to make it more random
            questionPairs = shuffleArray(players); // Changed to shuffle players list for random sequence, not pairs
           
            // Rebuild pairs using the shuffled player order
            const shuffledPlayers = questionPairs;
            questionPairs = [];

            for (let i = 0; i < shuffledPlayers.length; i++) {
                const asker = shuffledPlayers[i];
                const answerer = shuffledPlayers[(i + 1) % shuffledPlayers.length];
                questionPairs.push({ asker, answerer });
            }
        }

        function showNextQuestionPair() {
            if (currentQuestionIndex >= questionPairs.length) {
                showOptionalQuestions();
                return;
            }
           
            const currentPair = questionPairs[currentQuestionIndex];
            document.getElementById('askerName').textContent = currentPair.asker;
            document.getElementById('answererName').textContent = currentPair.answerer;
            document.getElementById('askedCount').textContent = currentQuestionIndex;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            document.getElementById('askedCount').textContent = currentQuestionIndex;
           
            if (currentQuestionIndex >= questionPairs.length) {
                showOptionalQuestions();
            } else {
                showNextQuestionPair();
            }
        }

        function skipToOptional() {
            showOptionalQuestions();
        }

        // --- Optional Questions Logic ---
        function showOptionalQuestions() {
            document.getElementById('questionsPhase').classList.add('hidden');
            document.getElementById('optionalQuestionsPhase').classList.remove('hidden');
            document.getElementById('optionalQuestionInstructions').classList.remove('hidden');
            document.getElementById('optionalQuestionTurn').classList.add('hidden');
        }

        function nextOptionalQuestion() {
            if (players.length < 2) {
                customAlert("لا يوجد لاعبون كافيون لسؤال اختياري.");
                return; 
            }
            // Hide instructions, show turn display
            document.getElementById('optionalQuestionInstructions').classList.add('hidden');
            document.getElementById('optionalQuestionTurn').classList.remove('hidden');

            const shuffled = shuffleArray(players);
            const asker = shuffled[0];
            const answerer = shuffled[1];

            document.getElementById('optionalAskerName').textContent = asker;
            document.getElementById('optionalAnswererName').textContent = answerer;
        }

        function proceedToVotingFromOptional() {
            document.getElementById('optionalQuestionsPhase').classList.add('hidden');
            showVoting();
        }

        // --- Voting Phase Logic (Challenge Mode) ---

        function showVoting() {
            document.getElementById('questionsPhase').classList.add('hidden');
            document.getElementById('optionalQuestionsPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.remove('hidden');
           
            currentVoterIndex = 0;
            playerVotes = {};
            votes = {}; 
           
            document.getElementById('currentRound').textContent = roundNumber;
           
            showNextVoter();
        }

        function showNextVoter() {
            if (currentVoterIndex >= players.length) {
                showRevealPhase();
                return;
            }
           
            const currentVoter = players[currentVoterIndex];

            document.getElementById('voterName').textContent = currentVoter;
            createVotingCards(currentVoter);
        }

        function createVotingCards(currentVoter) {
            const container = document.getElementById('votingCards');
            container.innerHTML = '';

            players.forEach(player => {
                if (player === currentVoter) return;
               
                const card = document.createElement('div');
                card.className = 'challenge-card p-4 rounded-xl cursor-pointer text-center text-white';
                card.setAttribute('data-player', player);
                
                card.onclick = () => {
                    card.classList.toggle('selected');
                };

                card.innerHTML = `
                    <div class="text-xl sm:text-2xl mb-2"><img src="https://i.postimg.cc/4NT5SYrq/2.png" class="w-8 h-8 inline-block"></div>
                    <div class="font-bold text-base sm:text-lg">${player}</div>
                `;
                container.appendChild(card);
            });
        }

        function confirmVote() {
            const currentVoter = players[currentVoterIndex];
            const selectedCards = document.querySelectorAll('#votingCards .challenge-card.selected');
            const selection = Array.from(selectedCards).map(card => card.getAttribute('data-player'));
            
            playerVotes[currentVoter] = selection;
            
            // This is just for display purposes now
            selection.forEach(selectedPlayer => {
                votes[selectedPlayer] = (votes[selectedPlayer] || 0) + 1;
            });
            
            currentVoterIndex++;
            showNextVoter();
        }

        // --- Reveal Logic ---
        function showRevealPhase() {
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('revealPhase').classList.remove('hidden');
            document.getElementById('revealInitial').classList.remove('hidden');
            document.getElementById('spinningWheel').classList.add('hidden');
        }

        function startReveal() {
            document.getElementById('revealInitial').classList.add('hidden');
            document.getElementById('spinningWheel').classList.remove('hidden');
            
            let impostersToReveal = [...imposters];
            spinForNextImposter(impostersToReveal);
        }

        async function spinForNextImposter(impostersToReveal) {
            if (impostersToReveal.length === 0) {
                await new Promise(resolve => setTimeout(resolve, 1500)); // Wait after the last reveal
                showWeshAlHarjaPhase();
                return;
            }

            const imposterToReveal = impostersToReveal.shift();
            const currentNameEl = document.getElementById('currentName');
            
            // Spin animation
            const spinDuration = 2000 + Math.random() * 1000;
            const spinInterval = 100;
            let elapsed = 0;

            const spin = () => {
                const randomIndex = Math.floor(Math.random() * players.length);
                currentNameEl.textContent = players[randomIndex];
                currentNameEl.className = 'reveal-text'; // Reset class
                
                if (elapsed < spinDuration) {
                    elapsed += spinInterval;
                    setTimeout(spin, spinInterval);
                } else {
                    // Land on the imposter
                    currentNameEl.textContent = imposterToReveal;
                    currentNameEl.className = 'reveal-text reveal-effect';
                    
                    // Wait then continue to next imposter or next phase
                    setTimeout(() => {
                        currentNameEl.className = currentNameEl.className.replace(' reveal-effect', ''); // Reset effect
                        spinForNextImposter(impostersToReveal);
                    }, 2500);
                }
            };
            spin();
        }
        
        // --- Wesh Al Harja Logic (New) ---
        function showWeshAlHarjaPhase() {
            document.getElementById('revealPhase').classList.add('hidden');
            document.getElementById('weshAlHarjaPhase').classList.remove('hidden');
            
            const imposterNames = imposters.join(' و ');
            const instructionsEl = document.getElementById('weshAlHarjaInstructions');
            instructionsEl.textContent = `يا فريق الملاقيف (${imposterNames})! هذه فرصتكم الأخيرة. خمنوا "وش الهرجة"!`;

            // Use the specific category of the secret word for choices
            const sourceCategoryKey = secretWordInfo.categoryKey;
            let wordSource = [];

            if (sourceCategoryKey && wordCategories[sourceCategoryKey] && wordCategories[sourceCategoryKey].words) {
                wordSource = wordCategories[sourceCategoryKey].words;
            } else {
                // Fallback to all selected categories if something went wrong
                selectedCategoryKeys.forEach(key => {
                    if (wordCategories[key] && wordCategories[key].words) {
                        wordSource.push(...wordCategories[key].words);
                    }
                });
            }
            
            const wrongWords = wordSource.filter(word => word !== secretWord);
            
            const shuffledWrongWords = shuffleArray(wrongWords);
            const choices = shuffledWrongWords.slice(0, 6);

            choices.push(secretWord);
            const finalChoices = shuffleArray(choices);

            const choicesContainer = document.getElementById('weshAlHarjaChoices');
            choicesContainer.innerHTML = '';
            
            finalChoices.forEach(word => {
                const button = document.createElement('button');
                button.className = 'bg-slate-700 hover:bg-sky-600 border border-slate-600 hover:border-sky-400 p-4 rounded-xl text-white font-semibold transition-all transform hover:scale-105';
                button.textContent = word;
                button.onclick = () => checkWeshAlHarjaGuess(word);
                choicesContainer.appendChild(button);
            });

            document.getElementById('weshAlHarjaResult').innerHTML = '';
        }

        function checkWeshAlHarjaGuess(guessedWord) {
            imposterGuessedCorrectly = (guessedWord === secretWord);
            const resultEl = document.getElementById('weshAlHarjaResult');
            const choiceButtons = document.querySelectorAll('#weshAlHarjaChoices button');

            choiceButtons.forEach(button => {
                button.disabled = true;
                if (button.textContent === secretWord) {
                    button.className = 'bg-green-600 border-green-400 p-4 rounded-xl text-white font-semibold';
                } else if (button.textContent === guessedWord) {
                    button.className = 'bg-red-600 border-red-400 p-4 rounded-xl text-white font-semibold';
                } else {
                     button.className = 'bg-slate-800 border-slate-700 p-4 rounded-xl text-gray-500 font-semibold';
                }
            });

            if (imposterGuessedCorrectly) {
                resultEl.textContent = '🎉 إجابة صحيحة! 🎉';
                resultEl.className = 'text-center mt-6 font-bold text-2xl text-green-400 animate-pulse';
            } else {
                resultEl.textContent = '😔 إجابة خاطئة 😔';
                resultEl.className = 'text-center mt-6 font-bold text-2xl text-red-400';
            }

            setTimeout(() => {
                document.getElementById('weshAlHarjaPhase').classList.add('hidden');
                showResults();
            }, 3000);
        }

        // --- Results and Score Logic ---

        function showResults() {
            document.getElementById('weshAlHarjaPhase').classList.add('hidden');
            document.getElementById('resultsPhase').classList.remove('hidden');
           
            calculateScores();
           
            let anyPlayerSucceeded = Object.values(roundScores).some(score => score === 100);
            const imposterNames = imposters.join(' و ');

            let randomCountText = '';
            if (imposterSelectionMode === 'random' || imposterSelectionMode === 'red_dice') {
                randomCountText = `<p class="text-slate-400 text-sm mt-1">(كان عدد الملاقيف لهذه الجولة: ${imposters.length})</p>`;
            }

            let resultHTML = `
                <div class="text-center mb-6">
                    <div class="text-5xl sm:text-6xl mb-4">${anyPlayerSucceeded ? '🎉' : '😔'}</div>
                    <h3 class="text-xl sm:text-2xl font-bold mb-4">
                        ${anyPlayerSucceeded ? 'اللاعبون كشفوا الملاقيف!' : 'نجح الملاقيف في التخفي!'}
                    </h3>
                    <p class="text-slate-300">الملاقيف كانوا: ${imposterNames}</p>
                    ${randomCountText}
                </div>
               
                <div class="bg-slate-700 rounded-xl p-4 sm:p-6 mb-6 border border-slate-600">
                    <h4 class="text-lg sm:text-xl font-bold mb-4 text-white text-center">🏆 إجمالي النقاط:</h4>
                    <div class="space-y-2">
            `;
           
            const sortedByScore = [...players].sort((a, b) => playerScores[b] - playerScores[a]);
           
            sortedByScore.forEach((player, index) => {
                const totalScore = playerScores[player];
                const roundScore = roundScores[player] || 0;
                const isLeader = index === 0;
               
                resultHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg ${isLeader ? 'bg-yellow-900/50 border-2 border-yellow-400' : 'bg-slate-600/50 border'} ">
                        <span class="font-semibold text-white flex items-center gap-2">
                            ${isLeader ? '👑' : (imposters.includes(player) ? '<img src="https://i.postimg.cc/nL9N2tgc/image.png" class="w-5 h-5">' : '<img src="https://i.postimg.cc/cCLH5MBY/image.png" class="w-5 h-5">')} ${player}
                        </span>
                        <span class="font-bold ${isLeader ? 'text-yellow-400' : 'text-blue-400'}">
                            +${roundScore} (${totalScore} إجمالي)
                        </span>
                    </div>
                `;
            });
           
            resultHTML += `
                    </div>
                </div>
               
                <div class="bg-slate-700 rounded-xl p-4 sm:p-6 border border-slate-600">
                    <h4 class="text-sm sm:text-lg font-bold mb-2 text-center text-white/70">🔤 الكلمة السرية كانت:</h4>
                    <div class="text-xl sm:text-2xl font-bold text-center text-red-400">${secretWord}</div>
                </div>
            `;
           
            document.getElementById('resultsContent').innerHTML = resultHTML;
        }

        function calculateScores() {
            roundScores = {}; // Reset for the current round
            let anyPlayerSucceeded = false;

            for (const voter in playerVotes) {
                // Regular players can succeed
                if (!imposters.includes(voter)) {
                     const selection = playerVotes[voter].sort().join(',');
                     const actual = [...imposters].sort().join(',');
                     if (selection === actual) {
                        anyPlayerSucceeded = true;
                        break; 
                    }
                }
            }

            players.forEach(player => {
                let score = 0;
                if (imposters.includes(player)) {
                    let baseScore = anyPlayerSucceeded ? 0 : 150;
                    let bonusScore = imposterGuessedCorrectly ? 50 : 0;
                    score = baseScore + bonusScore;
                } else {
                    const selection = (playerVotes[player] || []).sort().join(',');
                    const actual = [...imposters].sort().join(',');
                    if (selection === actual) {
                        score = 100;
                    }
                }
                roundScores[player] = score;
                playerScores[player] = (playerScores[player] || 0) + score;
            });
            
            saveGameState();
        }

        function newRound() {
            if (players.length === 0) {
                 resetGame();
                 return;
            }

            roundNumber++;
            imposters = [];
            votes = {};
            playerVotes = {};
            currentVoterIndex = 0;
            revealedRoles.clear();
            lockedRoles.clear();
            questionPairs = [];
            currentQuestionIndex = 0;
            imposterGuessedCorrectly = false; // Reset for the new round
            roundScores = {}; // Reset round scores
           
            secretWordInfo = generateRandomWordFromCategory();
            secretWord = secretWordInfo.word;
           
            let finalImposterCount = impostersCount;
            const maxPossible = Math.max(1, players.length - 1);
            if (imposterSelectionMode === 'random') {
                const playerCount = players.length;
                let min = 1, max = 1;
                if (playerCount <= 5) { min = 1; max = 2; }
                else if (playerCount <= 8) { min = 1; max = 3; }
                else { min = 2; max = 5; }
                max = Math.min(max, maxPossible);
                min = Math.min(min, max);
                finalImposterCount = Math.floor(Math.random() * (max - min + 1)) + min;
            } else if (imposterSelectionMode === 'red_dice') {
                const min = 1;
                const max = maxPossible;
                finalImposterCount = Math.floor(Math.random() * (max - min + 1)) + min;
            }

            const shuffledPlayers = shuffleArray(players);
            imposters = shuffledPlayers.slice(0, finalImposterCount);
           
            document.getElementById('resultsPhase').classList.add('hidden');
            document.getElementById('weshAlHarjaPhase').classList.add('hidden');
            
            navigateTo({ view: 'gamePhase', modal: null });

            // Show the first sub-phase of the new round
            document.getElementById('roleDistribution').classList.remove('hidden');
            document.getElementById('questionsPhase').classList.add('hidden');
            document.getElementById('optionalQuestionsPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('revealPhase').classList.add('hidden');
           
            createRoleCards();
        }

        function resetGame() {
            // This function is for starting a completely new game, resetting scores.
            playerScores = {};
            saveGameState(); // Save the cleared scores
            navigateTo({ view: 'categoryPhase', modal: null }); 
        }

        // --- Two Categories Modal Logic ---

        function openTwoCategoriesModal() {
            modalSelectedCategories.clear();
            populateModalCategories();
            navigateTo({ view: currentState.view, modal: 'twoCategoriesModal' });
        }

        function closeTwoCategoriesModal() {
            history.back();
        }

        function populateModalCategories() {
            const grid = document.getElementById('modalCategoriesGrid');
            grid.innerHTML = '';
           
            const wordCategoryKeys = Object.keys(wordCategories).filter(key => wordCategories[key].words);

            wordCategoryKeys.forEach(key => {
                const category = wordCategories[key];
                const isSelected = modalSelectedCategories.has(key);
               
                const button = document.createElement('button');
                button.setAttribute('data-category', key);
                button.onclick = () => toggleModalCategory(key, button);
                button.className = `
                    p-4 rounded-xl font-bold transition-all border-2
                    ${isSelected 
                        ? 'bg-sky-600 border-sky-400 text-white shadow-xl' 
                        : 'bg-slate-600 border-slate-500 text-slate-300 hover:bg-slate-500'
                    }
                `;
                button.innerHTML = `
                    <div class="text-xl mb-1">${category.emoji}</div>
                    <div class="text-sm">${category.name}</div>
                `;
                grid.appendChild(button);
            });
        }

        function toggleModalCategory(key, button) {
            if (modalSelectedCategories.has(key)) {
                modalSelectedCategories.delete(key);
                button.className = button.className.replace('bg-sky-600 border-sky-400 text-white shadow-xl', 'bg-slate-600 border-slate-500 text-slate-300 hover:bg-slate-500');
            } else {
                if (modalSelectedCategories.size >= 2) {
                    customAlert('الحد الأقصى هو اختيار تصنيفين فقط!');
                    return;
                }
                modalSelectedCategories.add(key);
                button.className = button.className.replace('bg-slate-600 border-slate-500 text-slate-300 hover:bg-slate-500', 'bg-sky-600 border-sky-400 text-white shadow-xl');
            }
        }

        function confirmTwoCategories() {
            if (modalSelectedCategories.size !== 2) {
                customAlert('يجب اختيار تصنيفين بالضبط للمتابعة.');
                return;
            }

            selectedCategoryKeys = Array.from(modalSelectedCategories);
           
            navigateTo({ view: 'setupPhase', modal: null });
            populatePlayersUI(); 
           
            updateSelectedCategoryDisplay('twoCategories'); 
        }

        // --- Settings & Info Modal Logic ---
        function closeSettingsModal() {
            history.back();
        }
        
        function closeHowToPlayModal() {
            history.back();
        }

        function showConfirmResetModal() {
            navigateTo({ view: currentState.view, modal: 'confirmResetModal' });
        }

        function closeConfirmResetModal() {
            history.back();
        }
        
        function showConfirmNewRoundModal() {
            navigateTo({ view: currentState.view, modal: 'confirmNewRoundModal' });
        }

        function closeConfirmNewRoundModal() {
            history.back();
        }

        function handleNewRoundClick() {
            if (players.length < 3) {
                customAlert('يجب أن تبدأ لعبة أولاً لبدء جولة جديدة.');
            } else {
                 showConfirmNewRoundModal();
            }
        }
        
        function handleNewRoundConfirm() {
            closeConfirmNewRoundModal(); // Close confirm modal first
            newRound();
        }

        function handleResetConfirm() {
            closeConfirmResetModal();
            resetGame();
        }

        // --- Scores Modal Logic ---
        function showScoresModal() {
            const list = document.getElementById('scoresList');
            list.innerHTML = ''; // Clear previous scores

            const currentPlayers = loadPlayerNames().filter(name => name !== '');
            const sortedPlayers = currentPlayers.length > 0 ? [...currentPlayers].sort((a, b) => (playerScores[b] || 0) - (playerScores[a] || 0)) : Object.keys(playerScores).sort((a,b) => playerScores[b] - playerScores[a]);

            if (sortedPlayers.length === 0) {
                 list.innerHTML = '<p class="text-slate-400 text-center">لا توجد نقاط مسجلة بعد.</p>';
            } else {
                sortedPlayers.forEach((player, index) => {
                    const score = playerScores[player] || 0;
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-3 rounded-lg ${index === 0 ? 'bg-yellow-900/50 border-2 border-yellow-400' : 'bg-slate-600/50 border'}`;
                    item.innerHTML = `
                        <span class="font-semibold text-white">${index === 0 ? '👑' : '<img src="https://i.postimg.cc/cCLH5MBY/image.png" class="w-5 h-5 inline-block">'} ${player}</span>
                        <span class="font-bold ${index === 0 ? 'text-yellow-400' : 'text-blue-400'}">${score}</span>
                    `;
                    list.appendChild(item);
                });
            }
            navigateTo({ view: currentState.view, modal: 'scoresModal' });
        }

        function closeScoresModal() {
            history.back();
        }
        
        function showConfirmScoreResetModal() {
             navigateTo({ view: currentState.view, modal: 'confirmScoreResetModal' });
        }
        function closeConfirmScoreResetModal() {
             history.back();
        }

        function handleScoreResetConfirm() {
            playerScores = {};
            saveGameState();
            closeConfirmScoreResetModal();
            // Re-show scores modal to reflect the change
            showScoresModal();
        }
       
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerNames(); // Load names first to have them available for scores modal
            loadGameState(); 

            function populateCategoryGrid() {
                const grid = document.getElementById('categoryGrid');
                if (!grid) return;
                grid.innerHTML = ''; // Clear existing content

                const categoryOrder = [
                    'foods', 'animals', 'countries', 'produce', 'drinks', 'clothing', 
                    'places', 'professions', 'sports_games', 'brands', 
                    'quran_surahs', 'quran_characters', 'sahaba', 'twoCategories', 'random'
                ];
                
                const specialCategories = {
                    twoCategories: {
                        name: "تصنيفين ✌️",
                        desc: "اصنع لعبتك بنفسك واختر تصنيفين من اختيارك",
                        onclick: "openTwoCategoriesModal()"
                    },
                    random: {
                        name: "مختلط عشوائي <img src='https://i.postimg.cc/7hZ6QMnT/image.png' class='w-5 h-5 inline-block'>",
                        desc: "اجعل الملقوف يضيع",
                        onclick: "selectCategory('random')"
                    }
                };

                categoryOrder.forEach(key => {
                    const button = document.createElement('button');
                    button.className = 'card';
                    button.setAttribute('data-category', key);

                    let categoryData;
                    if (wordCategories[key]) {
                        categoryData = wordCategories[key];
                        button.setAttribute('onclick', `selectCategory('${key}')`);
                    } else if (specialCategories[key]) {
                        categoryData = specialCategories[key];
                        button.setAttribute('onclick', specialCategories[key].onclick);
                    } else {
                        return; // Skip if key is not found
                    }
                    
                    button.innerHTML = `
                        <div class="card-img-overlay"></div>
                        <div class="card-description-box">
                            <div class="text-xl font-bold text-white">${categoryData.name}</div>
                            <div class="text-sm text-gray-200 mt-1">${categoryData.desc}</div>
                        </div>
                        <div class="go-corner"><div class="go-arrow">→</div></div>
                    `;
                    
                    grid.appendChild(button);
                });
            }

            populateCategoryGrid(); // Call the function to build the grid
            const initialState = { view: 'categoryPhase', modal: null };
            history.replaceState(initialState, '');
            updateUI(initialState);
            
            // Setup button listeners
            const howToPlayBtn = document.getElementById('howToPlayBtn');
            if(howToPlayBtn) {
                howToPlayBtn.onclick = () => navigateTo({ view: currentState.view, modal: 'howToPlayModal' });
            }
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.onclick = () => navigateTo({ view: currentState.view, modal: 'settingsModal' });
            }
            const scoresBtn = document.getElementById('scoresBtn');
             if (scoresBtn) {
                scoresBtn.onclick = showScoresModal;
            }
        });

    </script>
</body>
</html>



